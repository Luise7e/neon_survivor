<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="screen-orientation" content="portrait">
    <meta name="x5-orientation" content="portrait">
    <title>NEON SURVIVOR ARENA | Universal Battle Royale</title>
    <link rel="manifest" href="manifest.json">

    <!-- Firebase SDKs (compat mode) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <!-- Modular CSS -->
    <link rel="stylesheet" href="css/global.css">
    <link rel="stylesheet" href="css/mobile-controls.css">
    <link rel="stylesheet" href="css/game-ui.css">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@600;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            -webkit-user-select: none;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            position: fixed;
            background: #000;
            font-family: 'Orbitron', sans-serif;
        }

        body.desktop {
            cursor: none;
        }

        #gameCanvas {
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            touch-action: none;
            background: radial-gradient(circle at 50% 50%, #0f0f2e 0%, #000000 100%);
            z-index: 1; /* Canvas debe estar debajo de los controles pero visible */
            /* Mejorar calidad de renderizado - smooth para gráficos vectoriales */
            image-rendering: auto;
            image-rendering: -webkit-optimize-contrast;
            /* Habilitar aceleración por hardware */
            transform: translateZ(0);
            -webkit-transform: translateZ(0);
            will-change: transform;
            /* Antialiasing suave */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Custom Cursor (PC only) */
        .custom-cursor {
            position: fixed;
            pointer-events: none;
            z-index: 10000;
            mix-blend-mode: difference;
            display: none;
        }

        .custom-cursor.active {
            display: block;
        }

        .cursor-dot {
            width: 8px;
            height: 8px;
            background: #00ffff;
            border-radius: 50%;
            position: absolute;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 20px #00ffff, 0 0 40px #00ffff;
            animation: pulse-cursor 1s infinite;
        }

        .cursor-ring {
            width: 32px;
            height: 32px;
            border: 2px solid #ff00ff;
            border-radius: 50%;
            position: absolute;
            transform: translate(-50%, -50%);
            transition: all 0.1s ease;
            box-shadow: 0 0 20px #ff00ff;
        }

        @keyframes pulse-cursor {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.2); }
        }

        /* Aim Cursor (Mobile - shows shooting direction) */
        .aim-cursor {
            position: fixed;
            pointer-events: none;
            z-index: 9500;
            mix-blend-mode: screen;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.15s ease, visibility 0s linear 0.15s;
        }

        .aim-cursor.active {
            opacity: 1;
            visibility: visible;
            transition: opacity 0.15s ease, visibility 0s linear 0s;
        }

        .aim-cursor .cursor-dot {
            width:  5px;
            height: 5px;
            background: #ff00ff;
            border-radius: 50%;
            position: absolute;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 25px #ff00ff, 0 0 50px #ff00ff;
            animation: pulse-cursor 0.8s infinite;
        }

        .aim-cursor .cursor-ring {
            width: 18px;
            height: 18px;
            border: 1px solid #00ffff;
            border-radius: 50%;
            position: absolute;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 25px #00ffff, inset 0 0 15px rgba(0, 255, 255, 0.3);
        }

        /* =========================
           MOBILE CONTROLS
        ========================= */
        .mobile-controls {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: clamp(200px, 35vh, 320px); /* Responsive height */
            z-index: 500;
            pointer-events: none;
            display: none;
        }

        .mobile-controls.active {
            display: block;
        }

        /* Joystick Container - FIXED TOUCH AREA */
        .joystick-container {
            position: absolute;
            bottom: clamp(20px, 3vh, 35px);
            left: clamp(20px, 3vw, 35px);
            width: clamp(100px, 18vw, 140px); /* Responsive size */
            height: clamp(100px, 18vw, 140px); /* Responsive size */
            pointer-events: none; /* El contenedor no captura eventos */
        }

        .joystick-base {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: radial-gradient(circle at center, rgba(0, 255, 255, 0.12) 0%, rgba(0, 255, 255, 0.03) 100%);
            border: 2px solid rgba(0, 255, 255, 0.3);
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.2), inset 0 0 15px rgba(0, 255, 255, 0.08);
            pointer-events: all; /* Solo la base captura eventos */
            touch-action: none;
        }

        .joystick-stick {
            position: absolute;
            width: clamp(40px, 7vw, 60px); /* Responsive size */
            height: clamp(40px, 7vw, 60px); /* Responsive size */
            border-radius: 50%;
            background: linear-gradient(135deg, #00ffff 0%, #0099ff 100%);
            border: 2px solid #ffffff;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.7), 0 4px 12px rgba(0, 0, 0, 0.5);
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.05s ease-out;
            pointer-events: none; /* El stick no interfiere */
        }

        .joystick-stick.active {
            transform: translate(-50%, -50%) scale(1.1);
            box-shadow: 0 0 30px rgba(0, 255, 255, 1), 0 4px 15px rgba(0, 0, 0, 0.7);
        }

        /* Pause Button - NEON CIRCULAR STYLE - POSITIONED ABOVE LEFT JOYSTICK */
        .pause-btn-mobile {
            position: absolute;
            /* Position above left joystick, aligned to left */
            bottom: calc(clamp(20px, 3vh, 35px) + clamp(100px, 18vw, 140px) + clamp(10px, 2vh, 20px));
            left: clamp(20px, 3vw, 35px); /* aligned to joystick left */
            width: clamp(45px, 8vw, 65px); /* Responsive size */
            height: clamp(45px, 8vw, 65px); /* Responsive size */
            border-radius: 50%;
            background: linear-gradient(135deg, rgba(0, 255, 255, 0.2) 0%, rgba(255, 0, 255, 0.2) 100%);
            border: 3px solid #00ffff;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 25px rgba(0, 255, 255, 0.7), inset 0 0 15px rgba(0, 255, 255, 0.1);
            cursor: pointer;
            transition: all 0.2s ease;
            pointer-events: all;
            backdrop-filter: blur(10px);
        }

        .pause-btn-mobile::before,
        .pause-btn-mobile::after {
            content: '';
            position: absolute;
            width: clamp(3px, 0.6vw, 5px); /* Responsive size */
            height: clamp(12px, 2.5vh, 18px); /* Responsive size */
            background: linear-gradient(180deg, #00ffff, #ff00ff);
            border-radius: 2px;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.9);
        }

        .pause-btn-mobile::before {
            left: 30%; /* Percentage based */
        }

        .pause-btn-mobile::after {
            right: 30%; /* Percentage based */
        }

        .pause-btn-mobile:active {
            transform: scale(0.9);
            box-shadow: 0 0 35px rgba(0, 255, 255, 1), inset 0 0 20px rgba(0, 255, 255, 0.3);
        }

        .pause-btn-mobile:active::before,
        .pause-btn-mobile:active::after {
            box-shadow: 0 0 15px rgba(0, 255, 255, 1);
        }

        /* Action Buttons */
        .action-buttons {
            position: absolute;
            bottom: calc(clamp(20px, 3vh, 35px) + clamp(100px, 18vw, 140px) + clamp(40px, 6vh, 60px));
            right: clamp(20px, 3vw, 35px);
            display: flex;
            flex-direction: column;
            gap: clamp(15px, 3vh, 25px); /* Responsive gap */
            pointer-events: none; /* FIXED: Dejar pasar toques al canvas */
        }

        .action-btn {
            width: clamp(70px, 13vw, 100px); /* Responsive size */
            height: clamp(70px, 13vw, 100px); /* Responsive size */
            border-radius: 50%;
            background: linear-gradient(135deg, rgba(255, 0, 255, 0.9) 0%, rgba(138, 0, 230, 0.9) 100%);
            border: 3px solid #ffffff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: clamp(28px, 5vw, 42px); /* Responsive font */
            color: #fff;
            box-shadow: 0 0 25px rgba(255, 0, 255, 0.7), 0 5px 15px rgba(0, 0, 0, 0.5);
            cursor: pointer;
            transition: all 0.1s ease;
            position: relative;
            pointer-events: auto; /* FIXED: El botón sí debe capturar toques */
        }

        .action-btn.inactive {
            opacity: 0.3;
            background: linear-gradient(135deg, rgba(120, 120, 120, 0.6) 0%, rgba(80, 80, 80, 0.6) 100%);
        }

        .action-btn:active {
            transform: scale(0.9);
            box-shadow: 0 0 40px rgba(255, 0, 255, 1), 0 2px 10px rgba(0, 0, 0, 0.7);
        }

        .action-btn.shoot {
            background: linear-gradient(135deg, rgba(255, 0, 85, 0.9) 0%, rgba(255, 0, 150, 0.9) 100%);
            font-size: clamp(24px, 4.5vw, 35px); /* Responsive font */
        }

        .action-btn .btn-label {
            position: absolute;
            bottom: clamp(-20px, -3vh, -30px); /* Responsive position */
            font-size: clamp(8px, 1.5vw, 12px); /* Responsive font */
            color: rgba(255, 255, 255, 0.7);
            text-transform: uppercase;
            letter-spacing: 1px;
            white-space: nowrap;
        }

        .action-btn .cooldown-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            font-size: clamp(18px, 3.5vw, 28px); /* Responsive font */
            font-weight: 900;
        }

        .action-btn .cooldown-overlay.active {
            display: flex;
        }

        /* Shoot Joystick (Right Side) */
        /* Shoot Joystick Container - SAME SIZE AS MOVEMENT JOYSTICK */
        .shoot-joystick-container {
            position: absolute;
            bottom: clamp(20px, 3vh, 35px);
            right: clamp(20px, 3vw, 35px);
            width: clamp(100px, 18vw, 140px); /* Responsive size */
            height: clamp(100px, 18vw, 140px); /* Responsive size */
            pointer-events: none;
        }

        .shoot-joystick-container .joystick-base {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: radial-gradient(circle at center, rgba(255, 0, 255, 0.12) 0%, rgba(255, 0, 255, 0.03) 100%);
            border: 2px solid rgba(255, 0, 255, 0.3);
            box-shadow: 0 0 20px rgba(255, 0, 255, 0.2), inset 0 0 15px rgba(255, 0, 255, 0.08);
            pointer-events: all;
            touch-action: none;
        }

        .shoot-joystick-container .joystick-stick {
            position: absolute;
            width: clamp(40px, 7vw, 60px); /* Responsive size */
            height: clamp(40px, 7vw, 60px); /* Responsive size */
            border-radius: 50%;
            background: linear-gradient(135deg, #ff00ff 0%, #ff0088 100%);
            border: 2px solid #ffffff;
            box-shadow: 0 0 20px rgba(255, 0, 255, 0.7), 0 4px 12px rgba(0, 0, 0, 0.5);
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.05s ease-out;
            pointer-events: none;
        }

        .shoot-joystick-container .joystick-stick.active {
            transform: translate(-50%, -50%) scale(1.1);
            box-shadow: 0 0 30px rgba(255, 0, 255, 1), 0 4px 15px rgba(0, 0, 0, 0.7);
        }

        /* Ability Button Small (for dual joystick mode) - POSITIONED ABOVE RIGHT JOYSTICK, TOP RIGHT */
        .ability-btn-small {
            position: absolute;
            /* Position above right joystick, aligned to right */
            bottom: calc(clamp(20px, 3vh, 35px) + clamp(100px, 18vw, 140px) + clamp(10px, 2vh, 20px));
            right: clamp(20px, 3vw, 35px); /* aligned to joystick right */
            width: clamp(45px, 8vw, 65px); /* Responsive size */
            height: clamp(45px, 8vw, 65px); /* Responsive size */
            border-radius: 50%;
            background: linear-gradient(135deg, rgba(255, 0, 255, 0.2) 0%, rgba(138, 0, 230, 0.2) 100%);
            border: 3px solid #ff00ff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: clamp(22px, 4vw, 32px); /* Responsive font */
            color: #fff;
            box-shadow: 0 0 25px rgba(255, 0, 255, 0.7), inset 0 0 15px rgba(255, 0, 255, 0.1);
            cursor: pointer;
            transition: all 0.1s ease;
            pointer-events: all;
            backdrop-filter: blur(10px);
        }

        .ability-btn-small.inactive {
            opacity: 0.4;
            background: linear-gradient(135deg, rgba(120, 120, 120, 0.2) 0%, rgba(80, 80, 80, 0.2) 100%);
            border-color: rgba(255, 255, 255, 0.3);
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.3);
        }

        .ability-btn-small:active {
            transform: scale(0.9);
            box-shadow: 0 0 35px rgba(255, 0, 255, 1), inset 0 0 20px rgba(255, 0, 255, 0.3);
        }

        .ability-btn-small .cooldown-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 900;
        }

        .ability-btn-small .cooldown-overlay.active {
            display: flex;
        }

        /* =========================
           HUD - MINIMALISTA Y LIMPIO
        ========================= */
        .hud {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            pointer-events: none;
            display: none;
            flex-direction: row;
            flex-wrap: wrap;
            gap: clamp(4px, 1vw, 8px);
            justify-content: space-between;
            align-items: stretch;
            background: linear-gradient(180deg, rgba(0, 0, 0, 0.7) 0%, transparent 100%);
            padding: clamp(8px, 2vh, 12px) clamp(10px, 2vw, 15px);
            backdrop-filter: blur(10px);
        }

        .hud.active {
            display: flex;
        }

        .hud-panel {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-radius: 8px;
            padding: clamp(4px, 1vh, 6px) clamp(8px, 1.5vw, 12px);
            backdrop-filter: blur(8px);
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.2);
            flex: 1 1 auto;
            min-width: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 2px;
            transition: all 0.3s ease;
        }

        .hud-panel:hover {
            border-color: rgba(0, 255, 255, 0.6);
            box-shadow: 0 0 25px rgba(0, 255, 255, 0.4);
            transform: translateY(-2px);
        }

        .hud-panel.health-panel {
            flex: 1 1 100%;
            width: 100%;
            max-width: none;
            flex-direction: row;
            gap: clamp(6px, 1.5vw, 10px);
            order: 10;
            align-items: center;
        }

        .hud-panel.health-panel .hud-label {
            flex: 0 0 auto;
            min-width: 20px;
        }

        .hud-panel.health-panel .hud-value {
            flex: 0 0 auto;
            min-width: 30px;
        }

        .hud-panel.health-panel .health-bar-container {
            flex: 1 1 80%;
            margin-top: 0;
        }

        .hud-label {
            font-size: clamp(7px, 1.4vw, 9px);
            color: rgba(0, 255, 255, 0.7);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-family: 'Rajdhani', sans-serif;
            font-weight: 600;
            white-space: nowrap;
        }

        .hud-value {
            font-size: clamp(14px, 2.8vw, 18px);
            font-weight: 700;
            color: #00ffff;
            text-shadow: 0 0 10px rgba(0, 255, 255, 0.8), 0 0 20px rgba(0, 255, 255, 0.4);
            font-family: 'Orbitron', sans-serif;
            line-height: 1;
        }

        .health-bar-container {
            width: 100%;
            height: clamp(6px, 1.5vh, 10px);
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid rgba(0, 255, 255, 0.3);
            position: relative;
        }

        .health-bar {
            height: 100%;
            background: linear-gradient(90deg, #ff0055 0%, #ff00ff 50%, #00ffff 100%);
            background-size: 200% 100%;
            transition: width 0.3s ease;
            box-shadow: 0 0 15px rgba(255, 0, 255, 0.8);
            animation: health-pulse 2s ease-in-out infinite;
            border-radius: 10px;
        }

        @keyframes health-pulse {
            0%, 100% {
                background-position: 0% 50%;
                filter: brightness(1);
            }
            50% {
                background-position: 100% 50%;
                filter: brightness(1.2);
            }
        }

        /* Game area constraint - REMOVED DUPLICATE, using global.css instead */

        /* =========================
           LOADING SCREEN
        ========================= */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #000000 0%, #1a001a 50%, #000033 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 9500; /* Loading screen - highest priority */
            animation: bg-shift 5s ease-in-out infinite;
        }

        @keyframes bg-shift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .loading-logo {
            font-size: 60px;
            font-weight: 900;
            background: linear-gradient(45deg, #ff00ff, #00ffff, #ff00ff, #00ffff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            background-size: 300% 100%;
            animation: logo-shimmer 3s linear infinite, logo-pulse 2s ease-in-out infinite;
            margin-bottom: 30px;
            text-align: center;
            padding: 0 20px;
        }


        @keyframes logo-shimmer {
            0% { background-position: 0% 0%; }
            100% { background-position: 300% 0%; }
        }

        @keyframes logo-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .loading-subtitle {
            color: #00ffff;
            font-size: 14px;
            margin-bottom: 40px;
            text-transform: uppercase;
            letter-spacing: 3px;
            opacity: 0.8;
        }


        .loading-bar {
            width: 350px;
            max-width: 80%;
            height: 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            border: 2px solid rgba(0, 255, 255, 0.3);
        }

        .loading-progress {
            height: 100%;
            background: linear-gradient(90deg, #ff00ff, #00ffff, #ff00ff);
            background-size: 200% 100%;
            border-radius: 10px;
            animation: loading-fill 3s ease-in-out, loading-glow 2s ease-in-out infinite;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.8);
        }

        @keyframes loading-fill {
            from { width: 0%; }
            to { width: 100%; }
        }

        @keyframes loading-glow {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .loading-instructions {
            margin-top: 30px;
            color: rgba(255, 255, 255, 0.6);
            font-size: 12px;
            text-align: center;
            line-height: 1.6;
            max-width: 500px;
            padding: 0 20px;
        }



        .loading-instructions .platform-specific {
            display: none;
        }

        .loading-instructions .platform-specific.active {
            display: inline;
        }

        /* =========================
           NOTIFICATIONS
        ========================= */
        .notification {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, rgba(255, 0, 255, 0.95) 0%, rgba(0, 255, 255, 0.95) 100%);
            border: 3px solid #fff;
            border-radius: 15px;
            padding: 15px 30px;
            font-size: 18px;
            font-weight: 900;
            color: #fff;
            z-index: 5000;
            display: none;
            box-shadow: 0 0 40px rgba(255, 0, 255, 0.9);
            animation: notification-bounce 0.5s ease;
        }


        @keyframes notification-bounce {
            0%, 100% { transform: translateX(-50%) scale(1); }
            50% { transform: translateX(-50%) scale(1.1); }
        }

        /* =========================
           WAVE INDICATOR
        ========================= */
        .wave-indicator {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 80px;
            font-weight: 900;
            color: #00ffff;
            text-shadow: 0 0 60px #00ffff, 0 0 100px #ff00ff;
            z-index: 3000;
            display: none;
            animation: wave-announce 2.5s ease;
            text-align: center;
        }


        @keyframes wave-announce {
            0% { transform: translate(-50%, -50%) scale(0) rotate(-10deg); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.3) rotate(5deg); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1) rotate(0deg); opacity: 0; }
        }

        /* =========================
           WAVE COUNTDOWN
        ========================= */
        .wave-countdown {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 5000;
            text-align: center;
            pointer-events: none;
        }

        .countdown-title {
            font-size: clamp(32px, 6vw, 60px);
            font-weight: 900;
            background: linear-gradient(45deg, #00ffff, #ff00ff, #00ffff);
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: gradient-flow 3s ease infinite;
            margin-bottom: 20px;
            text-shadow: 0 0 30px rgba(0, 255, 255, 0.5);
        }

        .countdown-number {
            font-size: clamp(120px, 25vw, 250px);
            font-weight: 900;
            color: #00ffff;
            text-shadow:
                0 0 20px #00ffff,
                0 0 40px #00ffff,
                0 0 80px #00ffff,
                0 0 120px #ff00ff,
                0 0 160px #ff00ff;
            animation: countdown-pulse 1s ease-in-out;
            line-height: 1;
        }

        .countdown-subtitle {
            font-size: clamp(20px, 4vw, 36px);
            font-weight: 700;
            color: #ff00ff;
            text-shadow: 0 0 20px #ff00ff, 0 0 40px #ff00ff;
            margin-top: 20px;
            animation: pulse-glow 1s ease-in-out infinite;
        }

        @keyframes countdown-pulse {
            0% {
                transform: scale(0) rotate(-180deg);
                opacity: 0;
            }
            50% {
                transform: scale(1.2) rotate(10deg);
                opacity: 1;
            }
            100% {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
        }

        @keyframes pulse-glow {
            0%, 100% {
                opacity: 0.7;
                text-shadow: 0 0 20px #ff00ff, 0 0 40px #ff00ff;
            }
            50% {
                opacity: 1;
                text-shadow: 0 0 30px #ff00ff, 0 0 60px #ff00ff, 0 0 90px #ff00ff;
            }
        }

        @keyframes gradient-flow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }



        /* =========================
           GAME OVER SCREEN
        ========================= */
        .game-over {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.97);
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 6000; /* Game modals layer */
            padding: 20px;
        }

        .game-over.active {
            display: flex;
        }

        .game-over h1 {
            font-size: 70px;
            background: linear-gradient(45deg, #ff0055, #ff00ff, #8800ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 50px rgba(255, 0, 255, 0.8);
            margin-bottom: 30px;
            animation: title-glow 2s ease-in-out infinite;
        }



        @keyframes title-glow {
            0%, 100% { filter: brightness(1); }
            50% { filter: brightness(1.3); }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            max-width: 600px;
            width: 100%;
        }


        .stat-card {
            background: linear-gradient(135deg, rgba(10, 10, 40, 0.9) 0%, rgba(40, 0, 60, 0.9) 100%);
            border: 2px solid;
            border-image: linear-gradient(135deg, #00ffff, #ff00ff) 1;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.6);
        }

        .stat-value {
            font-size: 48px;
            font-weight: 900;
            background: linear-gradient(90deg, #00ffff, #ff00ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 30px rgba(0, 255, 255, 0.7);
        }


        .stat-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 8px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .btn-neon {
            background: linear-gradient(135deg, #ff00ff, #00ffff);
            border: none;
            padding: 15px 35px;
            font-size: 18px;
            font-weight: 900;
            color: #fff;
            cursor: pointer;
            border-radius: 50px;
            font-family: 'Orbitron', sans-serif;
            box-shadow: 0 0 30px rgba(255, 0, 255, 0.6);
            transition: all 0.3s ease;
            margin: 8px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }



        .btn-neon:hover {
            transform: scale(1.1);
            box-shadow: 0 0 50px rgba(0, 255, 255, 0.9);
        }

        .btn-neon:active {
            transform: scale(0.95);
        }
        /* =========================
           START MENU - VERTICAL OPTIMIZED
        ========================= */
        .start-menu {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                radial-gradient(ellipse at top, rgba(255, 0, 255, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at bottom, rgba(0, 255, 255, 0.15) 0%, transparent 50%),
                linear-gradient(180deg, #000014 0%, #0a0a1a 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-evenly;
            z-index: 8000; /* Menu screens layer */
            font-family: 'Orbitron', sans-serif;
            overflow-y: auto;
            overflow-x: hidden;
            padding: clamp(8px, 1vh, 12px) clamp(12px, 2.5vw, 20px) clamp(12px, 1.5vh, 18px);
            gap: clamp(6px, 1vh, 10px);
        }

        .start-menu.hidden {
            display: none;
        }

        /* Hero Section - COMPACT FOR VERTICAL */
        /* Hero Section - COMPACT FOR VERTICAL */
        .menu-hero {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: clamp(1px, 0.3vh, 3px);
            text-align: center;
            width: 100%;
            max-width: 800px;
            flex-shrink: 0;
            padding-top: clamp(4px, 0.5vh, 8px);
        }

        .menu-logo {
            font-size: clamp(22px, 5vh, 40px); /* Basado en altura para vertical */
            font-weight: 900;
            background: linear-gradient(135deg, #ff00ff 0%, #00ffff 50%, #ff00ff 100%);
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: gradient-shift 4s ease-in-out infinite, title-glow 3s ease-in-out infinite;
            letter-spacing: clamp(1.2px, 0.3vw, 2px);
            line-height: 0.9;
            filter: drop-shadow(0 0 20px rgba(255, 0, 255, 0.5));
        }

        @keyframes gradient-shift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .menu-subtitle {
            font-size: clamp(9px, 1.8vh, 12px); /* Basado en altura */
            color: #00ffff;
            text-transform: uppercase;
            letter-spacing: clamp(0.8px, 0.25vw, 1.5px);
            text-shadow: 0 0 10px rgba(0, 255, 255, 0.7);
            font-weight: 600;
            line-height: 1;
        }

        .menu-tagline {
            font-size: clamp(7px, 1.4vh, 10px); /* Basado en altura */
            color: rgba(255, 255, 255, 0.5);
            font-family: 'Rajdhani', sans-serif;
            font-weight: 600;
            letter-spacing: clamp(0.2px, 0.1vw, 0.6px);
            line-height: 1;
        }

        /* Login Container Wrapper */
        .login-container-wrapper {
            width: 100%;
            max-width: 420px;
            display: flex;
            justify-content: center;
            flex-shrink: 1;
            min-height: 0;
        }

        /* Login Card - COMPACT FOR VERTICAL */
        .login-card {
            background: linear-gradient(135deg, rgba(26, 0, 51, 0.8) 0%, rgba(10, 10, 40, 0.8) 100%);
            border: 1px solid;
            border-image: linear-gradient(135deg, rgba(255, 0, 255, 0.5), rgba(0, 255, 255, 0.5)) 1;
            border-radius: 12px;
            padding: clamp(8px, 1.5vh, 14px) clamp(12px, 2.5vw, 18px);
            backdrop-filter: blur(20px);
            box-shadow:
                0 4px 20px rgba(0, 0, 0, 0.4),
                inset 0 0 25px rgba(255, 0, 255, 0.05),
                0 0 35px rgba(255, 0, 255, 0.2);
            display: flex;
            flex-direction: column;
            gap: clamp(6px, 1vh, 10px);
            width: 100%;
        }

        .login-card-title {
            font-size: clamp(12px, 2.5vh, 16px); /* Basado en altura */
            font-weight: 700;
            text-align: center;
            background: linear-gradient(90deg, #ff00ff, #00ffff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: 0.4px;
            line-height: 1.1;
        }

        /* Google Sign-In Button - COMPACT */
        .google-signin-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            background: #ffffff;
            color: #3c4043;
            border: none;
            padding: clamp(8px, 1.5vh, 11px) clamp(12px, 3vw, 18px);
            font-size: clamp(11px, 2.2vh, 13px); /* Basado en altura */
            font-weight: 600;
            font-family: 'Roboto', 'Orbitron', sans-serif;
            border-radius: 10px;
            cursor: pointer;
            box-shadow:
                0 2px 8px rgba(0, 0, 0, 0.15),
                0 0 25px rgba(66, 133, 244, 0.3);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            width: 100%;
        }        .google-signin-btn:hover {
            box-shadow:
                0 4px 16px rgba(0, 0, 0, 0.25),
                0 0 50px rgba(66, 133, 244, 0.5);
            transform: translateY(-2px);
        }

        .google-signin-btn:active {
            transform: translateY(0);
        }

        .google-icon {
            width: clamp(16px, 3vh, 18px); /* Basado en altura */
            height: clamp(16px, 3vh, 18px);
            flex-shrink: 0;
        }

        /* Login Divider - COMPACT */
        .login-divider {
            display: flex;
            align-items: center;
            gap: 6px;
            margin: clamp(1px, 0.5vh, 3px) 0;
        }

        .divider-line {
            flex: 1;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        }

        .divider-text {
            color: rgba(255, 255, 255, 0.4);
            font-size: clamp(9px, 1.8vh, 11px); /* Basado en altura */
            font-weight: 600;
            font-family: 'Rajdhani', sans-serif;
            letter-spacing: 0.4px;
        }

        /* Guest Button - COMPACT */
        .guest-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.2) 0%, rgba(118, 75, 162, 0.2) 100%);
            color: #fff;
            border: 2px solid;
            border-image: linear-gradient(135deg, #667eea, #764ba2) 1;
            border-radius: 10px;
            padding: clamp(8px, 1.5vh, 11px) clamp(12px, 3vw, 18px);
            font-size: clamp(11px, 2.2vh, 13px); /* Basado en altura */
            font-weight: 700;
            font-family: 'Orbitron', sans-serif;
            cursor: pointer;
            box-shadow:
                0 2px 8px rgba(0, 0, 0, 0.15),
                inset 0 0 12px rgba(102, 126, 234, 0.1),
                0 0 25px rgba(102, 126, 234, 0.3);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-transform: uppercase;
            letter-spacing: 0.4px;
            width: 100%;
        }

        .guest-btn:hover {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.3) 0%, rgba(118, 75, 162, 0.3) 100%);
            box-shadow:
                0 4px 16px rgba(0, 0, 0, 0.25),
                inset 0 0 25px rgba(102, 126, 234, 0.2),
                0 0 50px rgba(102, 126, 234, 0.5);
            transform: translateY(-2px);
        }

        .guest-btn:active {
            transform: translateY(0);
        }

        .guest-icon {
            width: clamp(16px, 3vh, 18px); /* Basado en altura */
            height: clamp(16px, 3vh, 18px);
            flex-shrink: 0;
        }

        .btn-text {
            white-space: nowrap;
        }

        /* Login Benefits - COMPACT */
        .login-benefits {
            display: flex;
            justify-content: space-around;
            gap: clamp(6px, 1.2vw, 10px);
            margin-top: clamp(2px, 0.5vh, 5px);
            padding-top: clamp(5px, 1vh, 8px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .benefit-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            flex: 1;
        }

        .benefit-icon {
            font-size: clamp(14px, 2.8vh, 18px); /* Basado en altura */
            filter: drop-shadow(0 0 8px rgba(0, 255, 255, 0.5));
        }

        .benefit-text {
            font-size: clamp(8px, 1.5vh, 10px); /* Basado en altura */
            color: rgba(255, 255, 255, 0.6);
            text-align: center;
            font-family: 'Rajdhani', sans-serif;
            font-weight: 600;
            letter-spacing: 0.2px;
            line-height: 1;
        }

        /* User Menu Wrapper - COMPACT FOR VERTICAL */
        .user-menu-wrapper {
            width: 100%;
            max-width: 900px;
            display: flex;
            flex-direction: column;
            gap: clamp(8px, 1.5vh, 14px);
            flex-shrink: 1;
            min-height: 0;
        }

        /* User Profile Card - COMPACT */
        .user-profile-card {
            background: linear-gradient(135deg, rgba(26, 0, 51, 0.6) 0%, rgba(10, 10, 40, 0.6) 100%);
            border: 1px solid;
            border-image: linear-gradient(135deg, rgba(0, 255, 255, 0.5), rgba(255, 0, 255, 0.5)) 1;
            border-radius: 10px;
            padding: clamp(8px, 1.5vh, 12px) clamp(12px, 2.5vw, 16px);
            backdrop-filter: blur(20px);
            box-shadow:
                0 4px 20px rgba(0, 0, 0, 0.3),
                inset 0 0 25px rgba(0, 255, 255, 0.05),
                0 0 25px rgba(0, 255, 255, 0.2);
            flex-shrink: 0;
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: clamp(10px, 2vw, 15px);
        }

        .user-avatar {
            width: clamp(42px, 8vh, 56px); /* Basado en altura */
            height: clamp(42px, 8vh, 56px);
            border-radius: 50%;
            border: 2px solid #00ffff;
            box-shadow:
                0 0 20px rgba(0, 255, 255, 0.6),
                inset 0 0 15px rgba(0, 255, 255, 0.1);
            flex-shrink: 0;
            object-fit: cover;
            object-position: center;
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
        }

        .profile-info {
            display: flex;
            flex-direction: column;
            gap: 3px;
            flex: 1;
            min-width: 0;
        }

        .user-name {
            font-size: clamp(14px, 3vh, 20px); /* Basado en altura */
            color: #fff;
            font-weight: 700;
            text-shadow: 0 0 15px rgba(255, 0, 255, 0.6);
            letter-spacing: 0.4px;
            text-transform: uppercase;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            line-height: 1;
        }

        .guest-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: linear-gradient(135deg, rgba(255, 165, 0, 0.2), rgba(255, 140, 0, 0.2));
            border: 1px solid rgba(255, 165, 0, 0.5);
            color: #ffa500;
            padding: 3px 8px;
            border-radius: 14px;
            font-size: clamp(8px, 1.6vh, 10px); /* Basado en altura */
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.4px;
            box-shadow: 0 0 12px rgba(255, 165, 0, 0.3);
            width: fit-content;
        }        .guest-badge svg {
            animation: pulse-dot 2s ease-in-out infinite;
        }

        @keyframes pulse-dot {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        /* User Best Score - COMPACT */
        .user-best-score {
            display: flex;
            align-items: center;
            gap: 6px;
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.15), rgba(255, 165, 0, 0.15));
            border: 1px solid rgba(255, 215, 0, 0.4);
            padding: 4px 10px;
            border-radius: 10px;
            margin-top: 3px;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.2);
            width: fit-content;
        }

        .best-score-label {
            font-size: clamp(9px, 1.8vh, 11px); /* Basado en altura */
            color: rgba(255, 215, 0, 0.9);
            font-weight: 600;
            letter-spacing: 0.4px;
            text-transform: uppercase;
        }

        #bestScoreValue {
            font-size: clamp(12px, 2.5vh, 16px); /* Basado en altura */
            color: #ffd700;
            font-weight: 900;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.6);
            letter-spacing: 0.4px;
        }

        /* Action Grid - COMPACT FOR VERTICAL */
        .action-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: clamp(5px, 1vh, 8px);
            width: 100%;
            flex-shrink: 1;
            min-height: 0;
        }


        /* Action Cards - COMPACT */
        .action-card {
            background: linear-gradient(135deg, rgba(26, 0, 51, 0.5) 0%, rgba(10, 10, 40, 0.5) 100%);
            border: 1px solid rgba(255, 0, 255, 0.3);
            border-radius: 10px;
            padding: clamp(8px, 1.5vh, 12px) clamp(10px, 2.5vw, 14px);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: clamp(8px, 1.8vw, 12px);
            backdrop-filter: blur(10px);
            box-shadow:
                0 2px 8px rgba(0, 0, 0, 0.2),
                inset 0 0 12px rgba(255, 0, 255, 0.05);
            font-family: 'Orbitron', sans-serif;
            color: #fff;
            text-align: left;
        }        .action-card:hover {
            transform: translateY(-3px);
            border-color: rgba(0, 255, 255, 0.6);
            box-shadow:
                0 6px 20px rgba(0, 0, 0, 0.3),
                inset 0 0 25px rgba(0, 255, 255, 0.1),
                0 0 35px rgba(0, 255, 255, 0.4);
        }

        .action-card:active {
            transform: translateY(-2px);
        }

        /* Primary Action (START GAME) */
        .primary-action {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, rgba(0, 255, 0, 0.15) 0%, rgba(0, 255, 255, 0.15) 100%);
            border-color: rgba(0, 255, 255, 0.5);
            box-shadow:
                0 4px 16px rgba(0, 0, 0, 0.25),
                inset 0 0 20px rgba(0, 255, 255, 0.1),
                0 0 35px rgba(0, 255, 255, 0.3);
        }

        .primary-action:hover {
            border-color: rgba(0, 255, 0, 0.8);
            box-shadow:
                0 6px 20px rgba(0, 0, 0, 0.35),
                inset 0 0 30px rgba(0, 255, 0, 0.15),
                0 0 45px rgba(0, 255, 0, 0.5);
        }

        .action-icon {
            width: clamp(32px, 6.5vh, 42px); /* Basado en altura */
            height: clamp(32px, 6.5vh, 42px);
            min-width: clamp(32px, 6.5vh, 42px);
            background: linear-gradient(135deg, rgba(0, 255, 255, 0.2), rgba(0, 255, 0, 0.2));
            border: 2px solid rgba(0, 255, 255, 0.5);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 12px rgba(0, 255, 255, 0.4);
        }

        .action-icon svg {
            width: 60%;
            height: 60%;
            stroke: #00ffff;
            filter: drop-shadow(0 0 6px rgba(0, 255, 255, 0.7));
        }

        .action-icon-small {
            width: clamp(26px, 5.5vh, 34px); /* Basado en altura */
            height: clamp(26px, 5.5vh, 34px);
            min-width: clamp(26px, 5.5vh, 34px);
            background: linear-gradient(135deg, rgba(255, 0, 255, 0.15), rgba(138, 0, 230, 0.15));
            border: 1px solid rgba(255, 0, 255, 0.4);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 10px rgba(255, 0, 255, 0.3);
        }

        .action-icon-small svg {
            width: 55%;
            height: 55%;
            stroke: #ff00ff;
            filter: drop-shadow(0 0 5px rgba(255, 0, 255, 0.6));
        }

        .action-content {
            display: flex;
            flex-direction: column;
            gap: 2px;
            flex: 1;
            min-width: 0;
        }

        .action-title {
            font-size: clamp(10px, 2vh, 13px); /* Basado en altura */
            font-weight: 700;
            color: #fff;
            letter-spacing: 0.4px;
            text-transform: uppercase;
            line-height: 1;
        }

        .action-subtitle {
            font-size: clamp(7px, 1.5vh, 9px); /* Basado en altura */
            color: rgba(255, 255, 255, 0.6);
            font-family: 'Rajdhani', sans-serif;
            font-weight: 600;
            line-height: 1;
        }        /* Login Action (for guests) */
        .login-action {
            border-color: rgba(255, 165, 0, 0.4);
            background: linear-gradient(135deg, rgba(255, 165, 0, 0.1), rgba(255, 140, 0, 0.1));
        }

        .login-action:hover {
            border-color: rgba(255, 165, 0, 0.7);
            box-shadow:
                0 8px 24px rgba(0, 0, 0, 0.3),
                inset 0 0 30px rgba(255, 165, 0, 0.1),
                0 0 40px rgba(255, 165, 0, 0.4);
        }

        .login-action .action-icon-small {
            background: linear-gradient(135deg, rgba(255, 165, 0, 0.2), rgba(255, 140, 0, 0.2));
            border-color: rgba(255, 165, 0, 0.5);
            box-shadow: 0 0 15px rgba(255, 165, 0, 0.3);
        }

        .login-action .action-icon-small svg {
            stroke: #ffa500;
            filter: drop-shadow(0 0 8px rgba(255, 165, 0, 0.6));
        }

        /* Stats & Ranking Page */
        .stats-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 50% 50%, #0a0033 0%, #000000 100%);
            display: none;
            flex-direction: column;
            z-index: 8001; /* Menu screens layer */
            overflow-y: auto;
            overflow-x: hidden;
            padding: clamp(12px, 2vh, 20px) clamp(12px, 2.5vw, 20px);
        }

        .stats-page.active {
            display: flex;
        }

        .stats-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: clamp(10px, 1.8vh, 16px);
            flex-wrap: nowrap;
            gap: 10px;
            flex-shrink: 0;
        }

        .stats-title {
            font-size: clamp(18px, 4.2vw, 30px);
            font-weight: 900;
            background: linear-gradient(135deg, #00ffff, #ff00ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-transform: uppercase;
            letter-spacing: 1px;
            line-height: 1.1;
        }

        .close-stats-btn {
            background: linear-gradient(135deg, rgba(255, 0, 0, 0.9), rgba(200, 0, 0, 0.9));
            border: 2px solid rgba(255, 0, 0, 0.6);
            color: #fff;
            font-size: clamp(18px, 3.8vw, 24px);
            width: clamp(34px, 7vw, 44px);
            height: clamp(34px, 7vw, 44px);
            border-radius: 50%;
            cursor: pointer;
            font-weight: 900;
            flex-shrink: 0;
            box-shadow:
                0 3px 16px rgba(255, 0, 0, 0.5),
                inset 0 0 12px rgba(255, 0, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .close-stats-btn:hover {
            background: linear-gradient(135deg, rgba(255, 0, 0, 1), rgba(255, 50, 50, 1));
            transform: scale(1.12) rotate(90deg);
            box-shadow: 0 0 35px rgba(255, 0, 0, 0.8);
        }

        .stats-tabs {
            display: flex;
            gap: clamp(5px, 1.2vw, 8px);
            margin-bottom: clamp(10px, 1.8vh, 16px);
            flex-shrink: 0;
            flex-wrap: wrap;
        }

        .tab-btn {
            flex: 1;
            min-width: clamp(60px, 16vw, 85px);
            background: linear-gradient(135deg, rgba(26, 0, 51, 0.6), rgba(10, 10, 40, 0.6));
            border: 2px solid rgba(0, 255, 255, 0.3);
            color: rgba(255, 255, 255, 0.7);
            padding: clamp(7px, 1.4vh, 10px) clamp(8px, 2vw, 12px);
            font-size: clamp(10px, 2vw, 12px);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.4px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .tab-btn:hover {
            border-color: rgba(0, 255, 255, 0.6);
            color: #00ffff;
            transform: translateY(-2px);
        }

        .tab-btn.active {
            background: linear-gradient(135deg, rgba(0, 255, 255, 0.25), rgba(255, 0, 255, 0.25));
            border-color: #00ffff;
            color: #00ffff;
            box-shadow:
                0 0 20px rgba(0, 255, 255, 0.4),
                inset 0 0 15px rgba(0, 255, 255, 0.1);
        }

        .stats-content {
            display: none;
            flex-direction: column;
            gap: clamp(10px, 1.8vh, 16px);
            flex: 1;
            overflow-y: auto;
            padding-right: 4px;
        }

        .stats-content.active {
            display: flex;
        }

        .ranking-section {
            background: linear-gradient(135deg, rgba(26, 0, 51, 0.5) 0%, rgba(10, 10, 40, 0.5) 100%);
            border: 1px solid;
            border-image: linear-gradient(135deg, rgba(0, 255, 255, 0.4), rgba(255, 0, 255, 0.4)) 1;
            border-radius: 12px;
            padding: clamp(10px, 1.8vh, 16px) clamp(10px, 2vw, 14px);
            backdrop-filter: blur(15px);
            box-shadow:
                0 3px 16px rgba(0, 0, 0, 0.3),
                inset 0 0 20px rgba(0, 255, 255, 0.05);
        }

        .section-title {
            font-size: clamp(13px, 2.8vw, 18px);
            font-weight: 700;
            color: #fff;
            margin-bottom: clamp(8px, 1.5vh, 12px);
            text-transform: uppercase;
            letter-spacing: 0.6px;
            text-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
        }

        .my-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(clamp(60px, 16vw, 80px), 1fr));
            gap: clamp(6px, 1.5vw, 10px);
            margin-bottom: clamp(8px, 1.5vh, 12px);
        }

        .stat-box {
            background: linear-gradient(135deg, rgba(0, 255, 255, 0.1), rgba(255, 0, 255, 0.1));
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-radius: 8px;
            padding: clamp(8px, 1.5vh, 12px) clamp(6px, 1.5vw, 10px);
            text-align: center;
            box-shadow:
                0 2px 8px rgba(0, 0, 0, 0.2),
                inset 0 0 12px rgba(0, 255, 255, 0.05);
        }

        .stat-box-value {
            font-size: clamp(14px, 3vw, 20px);
            font-weight: 900;
            color: #00ffff;
            text-shadow: 0 0 8px rgba(0, 255, 255, 0.6);
            margin-bottom: 3px;
        }

        .stat-box-label {
            font-size: clamp(8px, 1.6vw, 10px);
            color: rgba(255, 255, 255, 0.6);
            text-transform: uppercase;
            letter-spacing: 0.3px;
            font-weight: 600;
        }

        .loading-stats {
            font-size: clamp(12px, 2.5vw, 15px);
            color: rgba(255, 255, 255, 0.5);
            text-align: center;
            padding: clamp(16px, 3vh, 24px);
            font-style: italic;
        }

        .ranking-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 clamp(4px, 1vh, 8px);
        }

        .ranking-table thead th {
            background: linear-gradient(135deg, rgba(0, 255, 255, 0.2), rgba(255, 0, 255, 0.2));
            color: #00ffff;
            padding: clamp(6px, 1.4vh, 10px) clamp(5px, 1.2vw, 8px);
            text-align: left;
            font-size: clamp(9px, 1.8vw, 11px);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.4px;
            border: 1px solid rgba(0, 255, 255, 0.3);
        }

        .ranking-table thead th:first-child {
            border-radius: 6px 0 0 6px;
        }

        .ranking-table thead th:last-child {
            border-radius: 0 6px 6px 0;
        }

        .ranking-table tbody tr {
            background: rgba(20, 20, 50, 0.4);
            transition: all 0.2s ease;
        }

        .ranking-table tbody tr:hover {
            background: rgba(0, 255, 255, 0.1);
            transform: translateX(3px);
        }

        .ranking-table tbody td {
            padding: clamp(6px, 1.4vh, 10px) clamp(5px, 1.2vw, 8px);
            font-size: clamp(10px, 2vw, 12px);
            color: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .ranking-table tbody td:first-child {
            border-radius: 6px 0 0 6px;
            font-weight: 900;
            color: #ff00ff;
            text-shadow: 0 0 8px rgba(255, 0, 255, 0.5);
        }

        .ranking-table tbody td:last-child {
            border-radius: 0 6px 6px 0;
           background: linear-gradient(135deg, #00ffff, #ff00ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-transform: uppercase;
            letter-spacing: 1px;
            line-height: 1.1;
        }

        .close-stats-btn {
            background: rgba(255, 0, 0, 0.8);
            border: none;
            color: #fff;
            font-size: clamp(18px, 3.5vw, 24px);
            width: clamp(36px, 7vw, 44px);
            height: clamp(36px, 7vw, 44px);
            border-radius: 50%;
            cursor: pointer;
            font-weight: 900;
            flex-shrink: 0;
            box-shadow: 0 0 30px rgba(255, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-stats-btn:hover {
            background: rgba(255, 0, 0, 1);
            transform: scale(1.1);
        }




        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(15px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ===========================
           CONTROL SIZE VARIATIONS
        =========================== */

        /* Small Controls */
        .mobile-controls.size-small .joystick-container,
        .mobile-controls.size-small .shoot-joystick-container {
            width: 80px;
            height: 80px;
        }
        .mobile-controls.size-small .joystick-base {
            width: 100%;
            height: 100%;
        }
        .mobile-controls.size-small .joystick-stick {
            width: 40px;
            height: 40px;
        }
        .mobile-controls.size-small .pause-btn-mobile,
        .mobile-controls.size-small .ability-btn-small {
            width: 42px;
            height: 42px;
            font-size: 22px;
        }
        .mobile-controls.size-small .pause-btn-mobile {
            bottom: calc(30px + 80px + 12px);
            left: 30px;
        }
        .mobile-controls.size-small .ability-btn-small {
            bottom: calc(30px + 80px + 12px);
            right: 30px;
        }
        .mobile-controls.size-small .pause-btn-mobile::before,
        .mobile-controls.size-small .pause-btn-mobile::after {
            width: 3px;
            height: 12px;
        }
        .mobile-controls.size-small .pause-btn-mobile::before {
            left: 14px;
        }
        .mobile-controls.size-small .pause-btn-mobile::after {
            right: 14px;
        }

        /* Normal Controls (default) */
        .mobile-controls.size-normal .joystick-container,
        .mobile-controls.size-normal .shoot-joystick-container {
            width: 120px;
            height: 120px;
        }
        .mobile-controls.size-normal .joystick-base {
            width: 100%;
            height: 100%;
        }
        .mobile-controls.size-normal .joystick-stick {
            width: 50px;
            height: 50px;
        }
        .mobile-controls.size-normal .pause-btn-mobile,
        .mobile-controls.size-normal .ability-btn-small {
            width: 55px;
            height: 55px;
            font-size: 28px;
        }
        .mobile-controls.size-normal .pause-btn-mobile {
            bottom: calc(30px + 120px + 15px);
            left: 30px;
        }
        .mobile-controls.size-normal .ability-btn-small {
            bottom: calc(30px + 120px + 15px);
            right: 30px;
        }

        /* Large Controls */
        .mobile-controls.size-large .joystick-container,
        .mobile-controls.size-large .shoot-joystick-container {
            width: 130px;
            height: 130px;
        }
        .mobile-controls.size-large .joystick-base {
            width: 100%;
            height: 100%;
        }
        .mobile-controls.size-large .joystick-stick {
            width: 65px;
            height: 65px;
        }
        .mobile-controls.size-large .pause-btn-mobile,
        .mobile-controls.size-large .ability-btn-small {
            width: 68px;
            height: 68px;
            font-size: 36px;
        }
        .mobile-controls.size-large .pause-btn-mobile {
            bottom: calc(30px + 130px + 18px);
            left: 30px;
        }
        .mobile-controls.size-large .ability-btn-small {
            bottom: calc(30px + 130px + 18px);
            right: 30px;
        }
        .mobile-controls.size-large .pause-btn-mobile::before,
        .mobile-controls.size-large .pause-btn-mobile::after {
            width: 5px;
            height: 20px;
        }
        .mobile-controls.size-large .pause-btn-mobile::before {
            left: 26px;
        }
        .mobile-controls.size-large .pause-btn-mobile::after {
            right: 26px;
        }

        /* ===========================
           COMPACT SETTINGS LIST STYLES
        =========================== */

        /* Setting Item Container */
        .setting-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: clamp(12px, 2.4vh, 16px) clamp(16px, 3.2vw, 22px);
            background: linear-gradient(135deg, rgba(26, 0, 51, 0.4) 0%, rgba(10, 10, 40, 0.4) 100%);
            border: 1px solid rgba(255, 0, 255, 0.25);
            border-radius: 12px;
            backdrop-filter: blur(12px);
            box-shadow:
                0 4px 16px rgba(0, 0, 0, 0.25),
                inset 0 0 20px rgba(255, 0, 255, 0.03);
            transition: all 0.3s ease;
            margin-bottom: clamp(8px, 1.6vh, 12px);
        }

        .setting-item:hover {
            border-color: rgba(255, 0, 255, 0.4);
            box-shadow:
                0 6px 20px rgba(0, 0, 0, 0.3),
                inset 0 0 25px rgba(255, 0, 255, 0.05);
            transform: translateY(-1px);
        }

        .setting-item:last-child {
            margin-bottom: 0;
        }

        /* Setting Info (Left side) */
        .setting-info {
            display: flex;
            align-items: center;
            gap: clamp(10px, 2vw, 14px);
            flex: 1;
        }

        .setting-icon {
            width: clamp(24px, 5vw, 32px);
            height: clamp(24px, 5vw, 32px);
            object-fit: contain;
            opacity: 0.8;
            transition: opacity 0.3s ease;
        }

        .setting-item:hover .setting-icon {
            opacity: 1;
        }

        .setting-name {
            font-size: clamp(14px, 2.8vw, 18px);
            font-weight: 600;
            color: #fff;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin: 0;
        }

        /* Setting Control (Right side) */
        .setting-control {
            display: flex;
            align-items: center;
            gap: clamp(8px, 1.6vw, 12px);
        }

        /* Radio Group Styles */
        .radio-group {
            display: flex;
            gap: clamp(6px, 1.2vw, 10px);
            flex-wrap: wrap;
        }

        .radio-option {
            position: relative;
        }

        .radio-option input[type="radio"] {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }

        .radio-option label {
            display: flex;
            align-items: center;
            gap: clamp(4px, 0.8vw, 6px);
            padding: clamp(6px, 1.2vh, 8px) clamp(8px, 1.6vw, 12px);
            background: rgba(20, 20, 50, 0.5);
            border: 1px solid rgba(255, 0, 255, 0.2);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: clamp(12px, 2.4vw, 14px);
            font-weight: 500;
            color: rgba(255, 255, 255, 0.8);
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .radio-option input[type="radio"]:checked + label {
            background: linear-gradient(135deg, rgba(255, 0, 255, 0.3), rgba(0, 255, 255, 0.3));
            border-color: #00ffff;
            color: #fff;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.3);
        }

        .radio-option label:hover {
            border-color: rgba(0, 255, 255, 0.4);
            transform: translateY(-1px);
        }

        /* Difficulty Icons */
        .difficulty-icon {
            width: clamp(16px, 3.2vw, 20px);
            height: clamp(16px, 3.2vw, 20px);
            object-fit: contain;
            opacity: 0.7;
        }

        .radio-option input[type="radio"]:checked + label .difficulty-icon {
            opacity: 1;
        }

        /* ===========================
           MODERN SETTINGS DESIGN
        =========================== */

        /* Logout Item */
        .logout-item {
            margin-bottom: clamp(30px, 5vh, 50px);
        }

        .logout-btn-full {
            width: 100%;
            background: linear-gradient(135deg, rgba(255, 0, 85, 0.15), rgba(255, 0, 0, 0.15));
            border: 2px solid rgba(255, 0, 85, 0.5);
            color: #ff3366;
            padding: clamp(16px, 3.2vh, 22px);
            border-radius: 16px;
            font-size: clamp(16px, 3.2vw, 20px);
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 2px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: clamp(12px, 2.4vw, 16px);
            box-shadow: 0 4px 20px rgba(255, 0, 85, 0.2);
        }

        .logout-btn-full:hover {
            background: linear-gradient(135deg, rgba(255, 0, 85, 0.25), rgba(255, 0, 0, 0.25));
            border-color: #ff0055;
            box-shadow: 0 0 30px rgba(255, 0, 85, 0.5);
            transform: translateY(-2px);
        }

        .logout-btn-full:active {
            transform: translateY(0);
        }

        .logout-icon {
            width: clamp(20px, 4vw, 26px);
            height: clamp(20px, 4vw, 26px);
        }

        .logout-text {
            font-weight: 800;
        }

        /* Modern Setting Item */
        .setting-item-modern {
            background: linear-gradient(135deg, rgba(26, 0, 51, 0.6), rgba(10, 10, 40, 0.6));
            border: 2px solid rgba(0, 255, 255, 0.2);
            border-radius: 18px;
            padding: clamp(18px, 3.6vh, 26px) clamp(20px, 4vw, 28px);
            backdrop-filter: blur(15px);
            box-shadow:
                0 4px 20px rgba(0, 0, 0, 0.3),
                inset 0 0 30px rgba(0, 255, 255, 0.05);
            transition: all 0.3s ease;
        }

        .setting-item-modern:hover {
            border-color: rgba(0, 255, 255, 0.4);
            box-shadow:
                0 6px 25px rgba(0, 0, 0, 0.4),
                inset 0 0 40px rgba(0, 255, 255, 0.08);
            transform: translateY(-2px);
        }

        /* Setting Label Modern */
        .setting-label-modern {
            display: flex;
            align-items: center;
            gap: clamp(12px, 2.4vw, 16px);
            margin-bottom: clamp(16px, 3.2vh, 22px);
        }

        .setting-icon-modern {
            width: clamp(24px, 4.8vw, 32px);
            height: clamp(24px, 4.8vw, 32px);
            color: #00ffff;
            filter: drop-shadow(0 0 8px rgba(0, 255, 255, 0.6));
        }

        .setting-name-modern {
            font-size: clamp(16px, 3.2vw, 20px);
            font-weight: 700;
            color: #fff;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            text-shadow: 0 0 15px rgba(0, 255, 255, 0.4);
        }

        /* Slider Container Modern */
        .slider-container-modern {
            display: flex;
            align-items: center;
            gap: clamp(16px, 3.2vw, 22px);
        }

        .slider-modern {
            -webkit-appearance: none;
            appearance: none;
            flex: 1;
            height: clamp(8px, 1.6vh, 10px);
            background: linear-gradient(90deg,
                rgba(0, 255, 255, 0.3) 0%,
                rgba(255, 0, 255, 0.3) 50%,
                rgba(0, 255, 255, 0.3) 100%);
            border-radius: 10px;
            outline: none;
            border: 1px solid rgba(0, 255, 255, 0.4);
            position: relative;
        }

        .slider-modern::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: clamp(22px, 4.4vw, 28px);
            height: clamp(22px, 4.4vw, 28px);
            background: linear-gradient(135deg, #00ffff, #ff00ff);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.8);
            transition: all 0.2s ease;
        }

        .slider-modern::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 0 30px rgba(0, 255, 255, 1);
        }

        .slider-modern::-moz-range-thumb {
            width: clamp(22px, 4.4vw, 28px);
            height: clamp(22px, 4.4vw, 28px);
            background: linear-gradient(135deg, #00ffff, #ff00ff);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.8);
            border: none;
            transition: all 0.2s ease;
        }

        .slider-modern::-moz-range-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 0 30px rgba(0, 255, 255, 1);
        }

        .slider-value-modern {
            font-size: clamp(16px, 3.2vw, 20px);
            font-weight: 800;
            color: #00ffff;
            min-width: clamp(50px, 10vw, 65px);
            text-align: center;
            text-shadow: 0 0 15px rgba(0, 255, 255, 0.8);
            background: rgba(0, 255, 255, 0.1);
            padding: clamp(4px, 0.8vh, 6px) clamp(8px, 1.6vw, 12px);
            border-radius: 8px;
            border: 1px solid rgba(0, 255, 255, 0.3);
        }

        /* Toggle Switch Modern */
        .toggle-switch-modern {
            position: relative;
            width: clamp(60px, 12vw, 75px);
            height: clamp(30px, 6vh, 38px);
            background: rgba(100, 100, 100, 0.3);
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid rgba(255, 255, 255, 0.2);
            flex-shrink: 0;
        }

        .toggle-switch-modern.active {
            background: linear-gradient(135deg, rgba(0, 255, 255, 0.3), rgba(255, 0, 255, 0.3));
            border-color: #00ffff;
            box-shadow: 0 0 25px rgba(0, 255, 255, 0.6);
        }

        .toggle-slider-modern {
            position: absolute;
            top: 3px;
            left: 3px;
            width: clamp(22px, 4.4vw, 28px);
            height: clamp(22px, 4.4vw, 28px);
            background: linear-gradient(135deg, #666, #888);
            border-radius: 50%;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
        }

        .toggle-switch-modern.active .toggle-slider-modern {
            transform: translateX(clamp(30px, 6vw, 37px));
            background: linear-gradient(135deg, #00ffff, #ff00ff);
            box-shadow: 0 0 20px rgba(0, 255, 255, 1);
        }

        /* Control Mode Selector */
        /* Control Scheme Radio Options */
        /* Size Selector */
        .size-selector {
            display: flex;
            gap: clamp(10px, 2vw, 14px);
            background: rgba(0, 0, 0, 0.3);
            padding: clamp(8px, 1.6vh, 10px);
            border-radius: 12px;
            border: 1px solid rgba(0, 255, 255, 0.2);
        }

        .size-btn {
            flex: 1;
            background: rgba(20, 20, 50, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.6);
            padding: clamp(14px, 2.8vh, 18px);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: clamp(6px, 1.2vh, 8px);
        }

        .size-btn.active {
            background: linear-gradient(135deg, rgba(0, 255, 255, 0.2), rgba(255, 0, 255, 0.2));
            border-color: #00ffff;
            color: #00ffff;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.4);
        }

        .size-btn:hover:not(.active) {
            border-color: rgba(0, 255, 255, 0.4);
            color: rgba(0, 255, 255, 0.8);
            transform: scale(1.05);
        }

        .size-btn svg {
            width: clamp(20px, 4vw, 28px);
            height: clamp(20px, 4vw, 28px);
        }

        .size-btn span {
            font-size: clamp(14px, 2.8vw, 18px);
            font-weight: 700;
        }

        /* Compact Logout Button */
        .logout-btn-compact {
            display: flex;
            align-items: center;
            gap: clamp(6px, 1.2vw, 8px);
            padding: clamp(8px, 1.6vh, 12px) clamp(12px, 2.4vw, 16px);
            background: linear-gradient(135deg, rgba(255, 0, 0, 0.3), rgba(200, 0, 0, 0.3));
            border: 1px solid rgba(255, 0, 0, 0.5);
            color: #ff6666;
            border-radius: 8px;
            font-size: clamp(12px, 2.4vw, 14px);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(255, 0, 0, 0.2);
        }

        .logout-btn-compact:hover {
            background: linear-gradient(135deg, rgba(255, 0, 0, 0.5), rgba(200, 0, 0, 0.5));
            border-color: #ff0000;
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.5);
            transform: translateY(-1px);
        }

        .logout-btn-compact svg {
            width: clamp(14px, 2.8vw, 18px);
            height: clamp(14px, 2.8vw, 18px);
        }



        /* ===========================
           UPGRADE MODAL STYLES - COMPACTO
        =========================== */
        .upgrade-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 7000;
            overflow: hidden;
            padding: clamp(10px, 2vh, 15px);
        }

        .upgrade-modal.active {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .upgrade-container {
            width: 100%;
            max-width: 900px;
            max-height: 95vh;
            background: linear-gradient(135deg, rgba(0, 20, 40, 0.95), rgba(20, 0, 40, 0.95));
            border: 2px solid #00ffff;
            border-radius: 15px;
            padding: clamp(12px, 2vh, 20px);
            box-shadow: 0 0 50px rgba(0, 255, 255, 0.4);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .upgrade-title {
            font-size: clamp(22px, 4vw, 32px);
            font-weight: 700;
            background: linear-gradient(45deg, #00ffff, #ff00ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-align: center;
            margin-bottom: clamp(10px, 2vh, 15px);
            text-transform: uppercase;
            letter-spacing: 2px;
            font-family: 'Orbitron', sans-serif;
        }

        .xp-section {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-radius: 10px;
            padding: clamp(8px, 1.5vh, 12px);
            margin-bottom: clamp(10px, 2vh, 15px);
            flex-shrink: 0;
        }

        .xp-bar-container {
            width: 100%;
            height: clamp(25px, 4vh, 35px);
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid #00ffff;
            border-radius: 20px;
            overflow: hidden;
            position: relative;
        }

        .xp-bar {
            height: 100%;
            background: linear-gradient(90deg, #00ffff, #0088ff);
            width: 0%;
            transition: width 0.5s ease;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
            position: relative;
        }

        .xp-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .xp-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: clamp(12px, 2vw, 16px);
            font-weight: 700;
            color: #fff;
            text-shadow: 0 0 10px rgba(0, 0, 0, 0.8);
            z-index: 1;
            font-family: 'Orbitron', sans-serif;
        }

        .upgrades-table-container {
            flex: 1;
            min-height: 0;
            overflow-y: auto;
            margin-bottom: clamp(10px, 2vh, 15px);
        }

        .upgrades-table-container::-webkit-scrollbar {
            width: 6px;
        }

        .upgrades-table-container::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 3px;
        }

        .upgrades-table-container::-webkit-scrollbar-thumb {
            background: rgba(0, 255, 255, 0.5);
            border-radius: 3px;
        }

        .upgrades-table-container::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 255, 255, 0.8);
        }

        /* Estilos antiguos removidos - ahora usamos tabla compacta */

        .upgrade-actions {
            display: flex;
            gap: clamp(8px, 2vw, 12px);
            justify-content: center;
            flex-shrink: 0;
            padding-top: clamp(8px, 1.5vh, 12px);
            border-top: 1px solid rgba(0, 255, 255, 0.2);
        }

        .btn-upgrade-action {
            padding: clamp(10px, 2vh, 14px) clamp(20px, 4vw, 35px);
            font-size: clamp(12px, 2.5vw, 16px);
            font-weight: 700;
            text-transform: uppercase;
            border: 2px solid;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            letter-spacing: 1px;
            font-family: 'Orbitron', sans-serif;
            flex: 1;
            max-width: 200px;
        }

        .btn-undo {
            background: rgba(255, 0, 85, 0.15);
            border-color: #ff0055;
            color: #ff0055;
        }

        .btn-undo:hover {
            background: #ff0055;
            color: #fff;
            box-shadow: 0 0 20px rgba(255, 0, 85, 0.6);
            transform: scale(1.05);
        }

        .btn-accept {
            background: rgba(0, 255, 255, 0.15);
            border-color: #00ffff;
            color: #00ffff;
        }

        .btn-accept:hover {
            background: #00ffff;
            color: #000;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.6);
            transform: scale(1.05);
        }

        /* User Options Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 9000; /* System modals layer */
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.95) 0%, rgba(20, 20, 60, 0.95) 100%);
            border: 2px solid #00ff55;
            border-radius: 16px;
            padding: clamp(20px, 4vh, 26px);
            max-width: 380px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 0 45px rgba(0, 255, 85, 0.4);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-40px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-user-info {
            text-align: center;
            margin-bottom: clamp(20px, 4vh, 26px);
        }

        .modal-user-avatar {
            width: clamp(70px, 15vw, 80px);
            height: clamp(70px, 15vw, 80px);
            border-radius: 50%;
            border: 3px solid #00ff55;
            margin: 0 auto clamp(12px, 2.5vh, 15px);
            box-shadow: 0 0 18px rgba(0, 255, 85, 0.5);
        }

        .modal-user-name {
            font-size: clamp(18px, 4vw, 20px);
            font-weight: bold;
            color: #00ff55;
            margin-bottom: 4px;
            text-shadow: 0 0 10px rgba(0, 255, 85, 0.7);
        }

        .modal-user-email {
            font-size: clamp(12px, 2.6vw, 13px);
            color: #00ffff;
            opacity: 0.8;
        }

        .modal-buttons {
            display: flex;
            flex-direction: column;
            gap: clamp(12px, 2.5vh, 14px);
        }

        .btn-logout {
            background: linear-gradient(135deg, #ff0055 0%, #ff5500 100%);
            color: white;
            border: 2px solid #ff0055;
            padding: clamp(13px, 2.6vh, 15px);
            border-radius: 10px;
            font-size: clamp(14px, 2.8vw, 15px);
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .btn-logout:hover {
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(255, 0, 85, 0.7);
            background: linear-gradient(135deg, #ff5500 0%, #ff0055 100%);
        }

        .btn-logout:active {
            transform: scale(0.98);
        }

        .btn-cancel {
            background: rgba(255, 255, 255, 0.1);
            color: #00ffff;
            border: 2px solid #00ffff;
            padding: clamp(13px, 2.6vh, 15px);
            border-radius: 10px;
            font-size: clamp(14px, 2.8vw, 15px);
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-cancel:hover {
            background: rgba(0, 255, 255, 0.2);
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
        }

        .btn-cancel:active {
            transform: scale(0.98);
        }

        /* Avatar Selection Modal Styles */
        .avatar-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 9001; /* Above user options modal */
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(8px);
        }

        .avatar-modal-overlay.active {
            display: flex;
        }

        .avatar-modal-content {
            background: linear-gradient(135deg, rgba(10, 10, 30, 0.98) 0%, rgba(30, 10, 50, 0.98) 100%);
            border: 3px solid #00ff55;
            border-radius: 16px;
            padding: clamp(20px, 4vh, 26px);
            max-width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 0 50px rgba(0, 255, 85, 0.6);
            animation: avatarModalSlideIn 0.3s ease-out;
        }

        @keyframes avatarModalSlideIn {
            from {
                transform: scale(0.92);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .avatar-modal-header {
            text-align: center;
            margin-bottom: clamp(18px, 3.5vh, 22px);
        }

        .avatar-modal-title {
            font-family: 'Orbitron', sans-serif;
            font-size: clamp(22px, 5vw, 26px);
            color: #00ffff;
            text-shadow: 0 0 12px rgba(0, 255, 255, 0.8);
            margin-bottom: 8px;
        }

        .avatar-modal-subtitle {
            font-family: 'Rajdhani', sans-serif;
            font-size: clamp(13px, 2.8vw, 15px);
            color: #999;
        }

        .avatar-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(75px, 1fr));
            gap: clamp(10px, 2vw, 13px);
            margin: clamp(18px, 3.5vh, 22px) 0;
            padding: clamp(14px, 3vh, 18px);
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            border: 1px solid rgba(0, 255, 255, 0.2);
            justify-items: center;
        }

        .avatar-option {
            width: clamp(70px, 15vw, 75px);
            height: clamp(70px, 15vw, 75px);
            border: 3px solid rgba(0, 255, 255, 0.3);
            border-radius: 50%; /* Circular */
            cursor: pointer;
            transition: all 0.3s ease;
            background-repeat: no-repeat;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
        }

        .avatar-option:hover {
            transform: scale(1.15);
            border-color: #00ffff;
            box-shadow: 0 0 25px rgba(0, 255, 255, 0.7);
            z-index: 10;
        }

        .avatar-option.selected {
            border-color: #00ff55;
            border-width: 4px;
            box-shadow: 0 0 30px rgba(0, 255, 85, 0.9);
            transform: scale(1.1);
        }

        .avatar-option.locked {
            opacity: 0.7;
            cursor: not-allowed;
            filter: brightness(0.7);
        }

        .avatar-option.locked:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(255, 100, 100, 0.5);
        }

        .avatar-option.locked::after {
            content: '🔒';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: clamp(22px, 5vw, 26px);
            z-index: 5;
            text-shadow: 0 0 8px rgba(0, 0, 0, 0.8);
        }

        .avatar-modal-buttons {
            display: flex;
            gap: clamp(12px, 2.5vw, 14px);
            justify-content: center;
            margin-top: clamp(18px, 3.5vh, 22px);
        }

        .btn-select-avatar {
            background: linear-gradient(135deg, #00ff55 0%, #00ffff 100%);
            color: #000;
            border: 2px solid #00ff55;
            padding: 15px 40px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Orbitron', sans-serif;
        }

        .btn-select-avatar:hover {
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(0, 255, 85, 0.7);
        }

        .btn-select-avatar:active {
            transform: scale(0.98);
        }

        .btn-select-avatar:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Avatar clickeable en el modal de usuario */
        #modalUserAvatar {
            cursor: pointer;
            transition: all 0.3s ease;
            object-fit: cover;
            object-position: center;
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
        }

        #modalUserAvatar:hover {
            transform: scale(1.1);
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.8) !important;
        }

        /* ===========================
           MAP SELECTOR MODAL
        =========================== */
        .map-selector-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            z-index: 10000;
            animation: fadeIn 0.3s ease;
        }

        .map-selector-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .map-selector-content {
            background: linear-gradient(135deg, rgba(10, 10, 40, 0.95) 0%, rgba(26, 0, 51, 0.95) 100%);
            border: 2px solid rgba(0, 255, 255, 0.5);
            border-radius: 20px;
            padding: clamp(20px, 4vh, 40px) clamp(15px, 3vw, 30px);
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow:
                0 10px 40px rgba(0, 0, 0, 0.5),
                inset 0 0 40px rgba(0, 255, 255, 0.1),
                0 0 60px rgba(0, 255, 255, 0.3);
            animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .map-selector-title {
            font-family: 'Orbitron', sans-serif;
            font-size: clamp(20px, 4vw, 32px);
            font-weight: 900;
            color: #00ffff;
            text-align: center;
            margin-bottom: clamp(15px, 3vh, 25px);
            text-shadow:
                0 0 20px rgba(0, 255, 255, 0.8),
                0 0 40px rgba(0, 255, 255, 0.4);
            letter-spacing: 2px;
        }

        .map-selector-subtitle {
            font-family: 'Rajdhani', sans-serif;
            font-size: clamp(12px, 2.5vw, 16px);
            color: rgba(255, 255, 255, 0.7);
            text-align: center;
            margin-bottom: clamp(20px, 4vh, 30px);
        }

        .map-types-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: clamp(12px, 2vw, 20px);
            margin-bottom: clamp(20px, 3vh, 30px);
        }

        .map-type-card {
            background: linear-gradient(135deg, rgba(26, 0, 51, 0.6) 0%, rgba(10, 10, 40, 0.6) 100%);
            border: 2px solid rgba(255, 0, 255, 0.3);
            border-radius: 12px;
            padding: clamp(12px, 2vh, 18px);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .map-type-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(0, 255, 255, 0.1) 0%, rgba(255, 0, 255, 0.1) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .map-type-card:hover::before {
            opacity: 1;
        }

        .map-type-card:hover {
            transform: translateY(-5px);
            border-color: rgba(0, 255, 255, 0.6);
            box-shadow:
                0 8px 25px rgba(0, 0, 0, 0.4),
                inset 0 0 30px rgba(0, 255, 255, 0.15),
                0 0 40px rgba(0, 255, 255, 0.4);
        }

        .map-type-card.selected {
            border-color: rgba(0, 255, 0, 0.8);
            background: linear-gradient(135deg, rgba(0, 255, 0, 0.2) 0%, rgba(0, 255, 255, 0.2) 100%);
            box-shadow:
                0 8px 25px rgba(0, 0, 0, 0.4),
                inset 0 0 30px rgba(0, 255, 0, 0.2),
                0 0 40px rgba(0, 255, 0, 0.5);
        }

        .map-type-icon {
            font-size: clamp(32px, 6vw, 48px);
            text-align: center;
            margin-bottom: 10px;
            filter: drop-shadow(0 0 10px rgba(0, 255, 255, 0.6));
        }

        .map-type-name {
            font-family: 'Orbitron', sans-serif;
            font-size: clamp(14px, 2.5vw, 18px);
            font-weight: 700;
            color: #00ffff;
            text-align: center;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .map-type-description {
            font-family: 'Rajdhani', sans-serif;
            font-size: clamp(11px, 2vw, 14px);
            color: rgba(255, 255, 255, 0.7);
            text-align: center;
            line-height: 1.4;
        }

        .map-type-card.selected .map-type-name {
            color: #00ff55;
        }

        .map-selector-actions {
            display: flex;
            gap: clamp(10px, 2vw, 15px);
            margin-top: clamp(20px, 3vh, 30px);
        }

        .map-selector-btn {
            flex: 1;
            padding: clamp(12px, 2vh, 16px) clamp(20px, 3vw, 30px);
            font-family: 'Orbitron', sans-serif;
            font-size: clamp(14px, 2.5vw, 18px);
            font-weight: 700;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .map-selector-btn.primary {
            background: linear-gradient(135deg, rgba(0, 255, 85, 0.8) 0%, rgba(0, 255, 255, 0.8) 100%);
            color: #000;
            box-shadow: 0 4px 15px rgba(0, 255, 85, 0.4);
        }

        .map-selector-btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 255, 85, 0.6);
        }

        .map-selector-btn.secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .map-selector-btn.secondary:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.5);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

    </style>
</head>
<body>
    <!-- Elemento requerido por game.js para controles móviles -->
    <span class="platform-specific mobile" style="display:none"></span>
    <!-- Start Menu / Login Screen -->
    <div class="start-menu" id="startMenu">
        <!-- Background image with high transparency_ -->
        <div style="position:absolute;inset:0;z-index:0;pointer-events:none;overflow:hidden;">
            <img src="settings-icons/app_logo_transparent.png" alt="Game Logo" style="width:70vw;max-width:700px;min-width:320px;opacity:0.13;display:block;margin:0 auto;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);filter:drop-shadow(0 0 40px #00ffff);">
        </div>
        <!-- Hero Section -->
        <div class="menu-hero" style="position:relative;z-index:1;">
            <div class="menu-logo">NEON SURVIVOR</div>
            <div class="menu-subtitle">Battle Royale Arena</div>
        </div>

        <!-- Google Sign-In (cuando NO está logueado) -->
        <div id="loginContainer" class="login-container-wrapper">
            <div class="login-card">
                <div class="login-card-title">Join the Arena</div>

                <button class="google-signin-btn" id="googleSignInBtn">
                    <svg class="google-icon" viewBox="0 0 24 24">
                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    <span class="btn-text">Sign in with Google</span>
                </button>

                <div class="login-divider">
                    <span class="divider-line"></span>
                    <span class="divider-text">OR</span>
                    <span class="divider-line"></span>
                </div>

                <button class="guest-btn" id="guestPlayBtn">
                    <svg class="guest-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                    <span class="btn-text">Continue as Guest</span>
                </button>

            </div>
        </div>

        <!-- User Menu (cuando está logueado) -->
        <div id="userMenuContainer" class="user-menu-wrapper" style="display:none;">
            <!-- User Profile Card -->
            <div class="user-profile-card action-card">
                <div class="profile-header">
                    <img id="userAvatar" class="user-avatar" src="" alt="User">
                    <div class="profile-info">
                        <div class="user-name" id="userName"></div>
                        <span id="guestIndicator" class="guest-badge" style="display:none;">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                <circle cx="12" cy="12" r="10"/>
                            </svg>
                            GUEST
                        </span>
                        <div id="userBestScore" class="user-best-score" style="display:none;">
                            <span class="best-score-label">Mejor puntuación:</span>
                            <span id="bestScoreValue">0</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Grid -->
            <div class="action-grid">
                <!-- Primary Action -->
                <button class="action-card primary-action" id="startGameBtn">
                    <div class="action-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                            <polygon points="5 3 19 12 5 21 5 3"></polygon>
                        </svg>
                    </div>
                    <div class="action-content">
                        <div class="action-title">START GAME</div>
                        <div class="action-subtitle">Begin from Wave 1</div>
                    </div>
                </button>

                <!-- Secondary Actions
                <button class="action-card secondary-action" id="levelSelectBtn">
                    <div class="action-icon-small">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="7" height="7"></rect>
                            <rect x="14" y="3" width="7" height="7"></rect>
                            <rect x="14" y="14" width="7" height="7"></rect>
                            <rect x="3" y="14" width="7" height="7"></rect>
                        </svg>
                    </div>
                    <div class="action-content">
                        <div class="action-title">SELECT LEVEL</div>
                        <div class="action-subtitle">Choose starting wave</div>
                    </div>
                </button>
                -->

                <button class="action-card secondary-action" id="mapTestBtn">
                    <div class="action-icon-small">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="7" height="7"></rect>
                            <rect x="14" y="3" width="7" height="7"></rect>
                            <rect x="14" y="14" width="7" height="7"></rect>
                            <rect x="3" y="14" width="7" height="7"></rect>
                            <path d="M10 6h4M10 18h4M6 10v4M18 10v4"></path>
                        </svg>
                    </div>
                    <div class="action-content">
                        <div class="action-title">MAP TEST</div>
                        <div class="action-subtitle">Procedural generation demo</div>
                    </div>
                </button>

                <button class="action-card secondary-action" id="statsBtn">
                    <div class="action-icon-small">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 3v18h18"></path>
                            <path d="M18 17V9"></path>
                            <path d="M13 17V5"></path>
                            <path d="M8 17v-3"></path>
                        </svg>
                    </div>
                    <div class="action-content">
                        <div class="action-title">STATS</div>
                        <div class="action-subtitle">Rankings & achievements</div>
                    </div>
                </button>

                <!-- Settings Button
                <button class="action-card secondary-action" id="settingsBtn">
                    <div class="action-icon-small">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="3"></circle>
                            <path d="M12 1v6m0 6v6m5.2-14.8l-4.2 4.2m-2 2l-4.2 4.2M23 12h-6m-6 0H1m14.8 5.2l-4.2-4.2m-2-2l-4.2-4.2"></path>
                        </svg>
                    </div>
                    <div class="action-content">
                        <div class="action-title">SETTINGS</div>
                        <div class="action-subtitle">Controls & preferences</div>
                    </div>
                </button>
                -->

                <!-- Login Button (for guests) -->
                <button class="action-card login-action" id="loginBtn" style="display:none;">
                    <div class="action-icon-small">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4m-5-4l5-5-5-5m5 5H3"></path>
                        </svg>
                    </div>
                    <div class="action-content">
                        <div class="action-title">LOGIN</div>
                        <div class="action-subtitle">Save your progress</div>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- User Options Modal (Logout) -->
    <div class="modal-overlay" id="userOptionsModal" style="display:none;">
        <div class="modal-content" style="max-width: 400px; text-align: center;">
            <h2 style="font-family: 'Orbitron', sans-serif; color: #00ffff; margin-bottom: 20px; font-size: 24px;">User Options</h2>

            <div style="margin: 30px 0;">
                <img id="modalUserAvatar" src="" alt="User" style="width: 80px; height: 80px; border-radius: 50%; border: 3px solid #00ffff; box-shadow: 0 0 20px rgba(0,255,255,0.5); display: block; margin: 0 auto;" title="Click to change avatar">
                <div id="modalUserName" style="font-family: 'Rajdhani', sans-serif; font-size: 20px; color: #fff; margin-top: 10px; font-weight: bold;"></div>
                <div id="modalUserEmail" style="font-family: 'Rajdhani', sans-serif; font-size: 14px; color: #999; margin-top: 5px;"></div>
            </div>

            <button class="btn-neon" id="logoutModalBtn" style="width: 100%; padding: 15px; font-size: 16px; margin-bottom: 10px; background: linear-gradient(135deg, #ff0055, #ff00ff);">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px; vertical-align: middle; margin-right: 8px;">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                    <polyline points="16 17 21 12 16 7"></polyline>
                    <line x1="21" y1="12" x2="9" y2="12"></line>
                </svg>
                Logout
            </button>

            <button class="btn-neon" id="closeUserOptionsBtn" style="width: 100%; padding: 15px; font-size: 16px; background: rgba(255,255,255,0.1);">
                Cancel
            </button>
        </div>
    </div>

    <!-- Avatar Selection Modal -->
    <div class="avatar-modal-overlay" id="avatarSelectionModal">
        <div class="avatar-modal-content">
            <div class="avatar-modal-header">
                <div class="avatar-modal-title">SELECT YOUR AVATAR</div>
                <div class="avatar-modal-subtitle">Choose your character from the available options</div>
            </div>

            <div id="avatarGrid" class="avatar-grid">
                <!-- Avatares se cargarán dinámicamente aquí -->
            </div>
        </div>
    </div>

    <!-- Map Selector Modal -->
    <div class="map-selector-modal" id="mapSelectorModal">
        <div class="map-selector-content">
            <div class="map-selector-title">🗺️ SELECT MAP TYPE</div>
            <div class="map-selector-subtitle">Choose the procedural generation algorithm for your battlefield</div>

            <div class="map-types-grid" id="mapTypesGrid">
                <!-- Maze -->
                <div class="map-type-card" data-map-type="maze">
                    <div class="map-type-icon">🌀</div>
                    <div class="map-type-name">Maze</div>
                    <div class="map-type-description">Complex labyrinth with narrow corridors and dead ends. Perfect for ambushes.</div>
                </div>

                <!-- Rooms -->
                <div class="map-type-card" data-map-type="rooms">
                    <div class="map-type-icon">🏛️</div>
                    <div class="map-type-name">Rooms</div>
                    <div class="map-type-description">Connected chambers with strategic chokepoints. Balanced tactical gameplay.</div>
                </div>

                <!-- Cellular -->
                <div class="map-type-card" data-map-type="cellular">
                    <div class="map-type-icon">🌿</div>
                    <div class="map-type-name">Cellular</div>
                    <div class="map-type-description">Organic cave-like structures. Natural and unpredictable terrain.</div>
                </div>

                <!-- Arena -->
                <div class="map-type-card" data-map-type="arena">
                    <div class="map-type-icon">⚔️</div>
                    <div class="map-type-name">Arena</div>
                    <div class="map-type-description">Open central battlefield with perimeter walls. Pure combat focus.</div>
                </div>

                <!-- Symmetrical -->
                <div class="map-type-card" data-map-type="symmetrical">
                    <div class="map-type-icon">🔷</div>
                    <div class="map-type-name">Symmetrical</div>
                    <div class="map-type-description">Mirrored layout for balanced competitive matches. Fair positioning.</div>
                </div>

                <!-- Jungla -->
                <div class="map-type-card" data-map-type="jungla">
                    <div class="map-type-icon">🌳</div>
                    <div class="map-type-name">Jungla</div>
                    <div class="map-type-description">Dense vegetation with scattered clearings. Stealth and cover tactics.</div>
                </div>
            </div>

            <div class="map-selector-actions">
                <button class="map-selector-btn secondary" id="mapSelectorCancelBtn">Cancel</button>
                <button class="map-selector-btn primary" id="mapSelectorStartBtn">Start Game</button>
            </div>
        </div>
    </div>

    <!-- Stats & Ranking Page -->
    <div class="stats-page" id="statsPage">
        <div class="stats-header">
            <div class="stats-title">Stats & Ranking</div>
            <button class="close-stats-btn" id="closeStatsBtn">×</button>
        </div>
                <!-- Tabs -->
        <div class="stats-tabs">
            <button class="tab-btn active" data-tab="daily-score" data-period="daily">Daily</button>
            <button class="tab-btn" data-tab="monthly-score" data-period="monthly">Monthly</button>
            <button class="tab-btn" data-tab="alltime-score" data-period="alltime">All-Time</button>
        </div>

        <!-- Mis Estadísticas -->
        <div class="ranking-section">
            <div class="section-title">My Stats</div>
            <div class="my-stats" id="myStats">
                <div class="stat-box">
                    <div class="stat-box-value" id="totalGames">-</div>
                    <div class="stat-box-label">Total Games</div>
                </div>
                <div class="stat-box">
                    <div class="stat-box-value" id="bestScore">-</div>
                    <div class="stat-box-label">Best Score</div>
                </div>
                <div class="stat-box">
                    <div class="stat-box-value" id="bestWave">-</div>
                    <div class="stat-box-label">Max Wave</div>
                </div>
                <div class="stat-box">
                    <div class="stat-box-value" id="totalKills">-</div>
                    <div class="stat-box-label">Total Kills</div>
                </div>
            </div>
            <div class="loading-stats" id="myStatsLoading" style="display:none;">Loading...</div>
        </div>



        <!-- Daily Score -->
        <div class="stats-content active" id="daily-score">
            <div class="ranking-section">
                <div class="section-title">Best Score Today</div>
                <div class="loading-stats">Loading...</div>
                <table class="ranking-table" id="dailyScoreTable" style="display:none;">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Player</th>
                            <th>Score</th>
                            <th>Wave</th>
                        </tr>
                    </thead>
                    <tbody id="dailyScoreBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Monthly Score -->
        <div class="stats-content" id="monthly-score">
            <div class="ranking-section">
                <div class="section-title">Best Score (Last 30 Days)</div>
                <div class="loading-stats">Loading...</div>
                <table class="ranking-table" id="monthlyScoreTable" style="display:none;">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Player</th>
                            <th>Score</th>
                            <th>Wave</th>
                        </tr>
                    </thead>
                    <tbody id="monthlyScoreBody"></tbody>
                </table>
            </div>
        </div>

        <!-- All-Time Score -->
        <div class="stats-content" id="alltime-score">
            <div class="ranking-section">
                <div class="section-title">All-Time Best Score</div>
                <div class="loading-stats">Loading...</div>
                <table class="ranking-table" id="alltimeScoreTable" style="display:none;">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Player</th>
                            <th>Score</th>
                            <th>Wave</th>
                        </tr>
                    </thead>
                    <tbody id="alltimeScoreBody"></tbody>
                </table>
            </div>
        </div>

    </div>

    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
    <img src="settings-icons/app_logo_transparent.png" alt="Game Logo" style="display:block;margin:0 auto;max-width:220px;width:60vw;height:auto;filter:drop-shadow(0 0 30px #00ffff);">
        <div class="loading-bar">
            <div class="loading-progress"></div>
        </div>
    </div>


    <!-- HUD - FULL WIDTH TOP BAR -->
    <div class="hud" id="gameHUD">
        <div class="hud-panel">
            <div class="hud-label">WAVE</div>
            <div class="hud-value" id="waveDisplay">1</div>
        </div>
        <div class="hud-panel health-panel">
            <div class="hud-label">HP</div>
            <div class="hud-value" id="healthText">100</div>
            <div class="health-bar-container">
                <div class="health-bar" id="healthBar" style="width: 100%;"></div>
            </div>
        </div>
        <div class="hud-panel">
            <div class="hud-label">KILLS</div>
            <div class="hud-value" id="killsDisplay">0</div>
        </div>
        <div class="hud-panel">
            <div class="hud-label">ENEMIES</div>
            <div class="hud-value" id="enemiesDisplay">0/0</div>
        </div>
        <div class="hud-panel">
            <div class="hud-label">SCORE</div>
            <div class="hud-value" id="scoreDisplay">0</div>
        </div>
    </div>

    <!-- MINIMAP - Top Right Corner (50% size) -->
    <canvas id="minimapCanvas" width="90" height="90" style="
        position: fixed;
        top: 18px;
        right: 18px;
        z-index: 1100;
        border-radius: 12px;
        box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
        background: rgba(10, 10, 26, 0.95);
        opacity: 0;
        transition: opacity 0.3s ease;
        pointer-events: auto;
        border: 2px solid rgba(0, 255, 255, 0.6);
    "></canvas>

    <!-- DEBUG BUTTON - TOP RIGHT -->
    <button id="debugPauseBtn" style="position:unset!important;top:90%!important;right:43%!important;width:60px!important;height:60px!important;background:red!important;color:white!important;border:3px solid yellow!important;border-radius:50%!important;z-index:99999!important;font-size:24px!important;font-weight:bold!important;cursor:pointer!important;">⏸</button>

    <!-- Mobile Controls -->
    <div class="mobile-controls" id="mobileControls">
        <!-- Pause Button -->
        <button class="pause-btn-mobile" id="pauseBtnMobile"></button>

        <!-- Move Joystick (Left) - HIDDEN: Using dynamic joysticks now -->
        <div class="joystick-container" id="joystickContainer" style="display: none;">
            <div class="joystick-base" id="joystickBase"></div>
            <div class="joystick-stick" id="joystickStick"></div>
        </div>

        <!-- Shoot Joystick (Right) - HIDDEN: Using dynamic joysticks now -->
    <div class="shoot-joystick-container" id="shootJoystickContainer" style="display: none;">
            <div class="joystick-base" id="shootJoystickBase"></div>
            <div class="joystick-stick" id="shootJoystickStick"></div>
        </div>

        <!-- Action Buttons - For tap mode -->
        <div class="action-buttons" id="actionButtons">
            <button class="action-btn inactive" id="abilityBtn">
                ⚡
                <span class="btn-label">ABILITY</span>
                <div class="cooldown-overlay">
                    <span class="cooldown-text">0</span>
                </div>
            </button>
        </div>

        <!-- Ability Button Small - For dual joystick mode -->
        <button class="ability-btn-small inactive" id="abilityBtnSmall" style="display:none;">
            ⚡
            <div class="cooldown-overlay">
                <span class="cooldown-text">0</span>
            </div>
        </button>
    </div>


    <!-- Notification -->
    <div class="notification" id="notification"></div>

    <!-- Wave Indicator -->
    <div class="wave-indicator" id="waveIndicator"></div>

    <!-- Wave Countdown -->
    <div class="wave-countdown" id="waveCountdown" style="display:none;">
        <div class="countdown-title" id="countdownTitle">WAVE 1</div>
        <div class="countdown-number" id="countdownNumber">5</div>
        <div class="countdown-subtitle">GET READY!</div>
    </div>

    <!-- Upgrade Modal -->
    <div class="upgrade-modal" id="upgradeModal">
        <div class="upgrade-container">
            <div class="upgrade-title">⚡ LEVEL UP ⚡</div>

            <!-- XP Section - Compacta -->
            <div class="xp-section">
                <div class="xp-bar-container">
                    <div class="xp-bar" id="xpBar"></div>
                    <div class="xp-text" id="xpText">0 XP</div>
                </div>
            </div>

            <!-- Ad Bonus Section -->
            <div id="adBonusSection" style="
                display: block;
                text-align: center;
                margin: 8px 0;
                padding: 10px;
                background: linear-gradient(135deg, rgba(255,215,0,0.1), rgba(255,165,0,0.1));
                border: 2px solid rgba(255,215,0,0.4);
                border-radius: 8px;
                box-shadow: 0 0 20px rgba(255,215,0,0.3);
            ">
                <button id="watchAdBtn" style="
                    background: linear-gradient(135deg, #FFD700, #FFA500);
                    border: 2px solid #FFD700;
                    color: #000;
                    padding: 10px 20px;
                    border-radius: 8px;
                    font-size: clamp(13px, 2.5vw, 16px);
                    font-weight: 700;
                    cursor: pointer;
                    font-family: 'Orbitron', sans-serif;
                    text-transform: uppercase;
                    box-shadow: 0 0 20px rgba(255,215,0,0.5);
                    transition: all 0.3s ease;
                    display: inline-block;
                ">
                    📺 Watch Ad (1 per wave) for x3 Bonus
                </button>
                <div id="bonusActiveIndicator" style="
                    display: none;
                    color: #FFD700;
                    font-size: clamp(14px, 2.8vw, 18px);
                    font-weight: 700;
                    font-family: 'Orbitron', sans-serif;
                    text-shadow: 0 0 10px #FFD700;
                    animation: pulse-glow 1.5s ease-in-out infinite;
                ">
                    ✨ x3 BONUS ACTIVE - Use on all upgrades this wave!
                </div>
            </div>

            <!-- Upgrades Table -->
            <div class="upgrades-table-container" id="upgradesGrid">
                <!-- Dynamically generated table -->
            </div>

            <!-- Action Buttons -->
            <div class="upgrade-actions">
                <button class="btn-upgrade-action btn-undo" id="undoUpgradesBtn">↶ UNDO</button>
                <button class="btn-upgrade-action btn-accept" id="acceptUpgradesBtn">✓ CONTINUE</button>
            </div>
        </div>
    </div>

    <!-- Pause Overlay -->
    <div class="game-over" id="pauseOverlay" style="display:none; z-index:6500; background:rgba(0,0,0,0.95);">
        <div style="max-width: 900px; width: 95%; max-height: 95vh; display: flex; flex-direction: column; padding: 10px 15px;">

            <!-- Header: Título centrado arriba -->
            <div style="text-align: center; margin-bottom: 12px;">
                <h1 style="font-family: 'Orbitron', sans-serif; font-size: clamp(28px, 5vw, 42px); background: linear-gradient(45deg, #00ffff, #ff00ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin: 0; text-shadow: 0 0 30px #00ffff, 0 0 60px #ff00ff; letter-spacing: 3px; animation: title-glow 2s ease-in-out infinite;">PAUSA</h1>
            </div>

            <!-- Botones en fila horizontal -->
            <div style="display: flex; gap: 10px; justify-content: center; margin-bottom: 15px;">
                <button class="action-card" id="resumeBtn" >▶ RESUME</button>
                <button class="action-card" id="abortBtn" style="background: #ff0050;">✕ END GAME</button>
            </div>

            <!-- Stats Section - Compacta y paginada -->
            <div style="background: linear-gradient(135deg, rgba(0,255,255,0.08), rgba(255,0,255,0.08)); border: 2px solid rgba(0,255,255,0.4); border-radius: 12px; padding: 12px; box-shadow: 0 0 30px rgba(0,255,255,0.3), inset 0 0 20px rgba(0,255,255,0.1); flex: 1; display: flex; flex-direction: column; min-height: 0; position: relative;">
                <h2 style="font-family: 'Orbitron', sans-serif; font-size: clamp(14px, 2.8vw, 17px); color: #00ffff; text-align: center; margin: 0 0 10px 0; text-shadow: 0 0 10px #00ffff; letter-spacing: 2px;">CURRENT STATS</h2>

                <!-- Grid de estadísticas compacto -->
                <div id="pauseStatsGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 6px; font-family: 'Rajdhani', sans-serif; flex: 1; align-content: start; overflow-y: auto; padding-right: 5px;">
                    <!-- Stats will be injected here -->
                </div>

                <!-- Paginación (solo visible si hay muchas stats) -->
                <div id="pauseStatsPagination" style="display: none; justify-content: center; align-items: center; gap: 10px; margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(0,255,255,0.2);">
                    <button id="prevPageBtn" style="background: rgba(0,255,255,0.2); border: 1px solid #00ffff; color: #00ffff; padding: 5px 12px; border-radius: 5px; cursor: pointer; font-size: 14px; transition: all 0.3s;">◄</button>
                    <span id="pageIndicator" style="color: #00ffff; font-size: 14px; font-weight: 600;">1 / 1</span>
                    <button id="nextPageBtn" style="background: rgba(0,255,255,0.2); border: 1px solid #00ffff; color: #00ffff; padding: 5px 12px; border-radius: 5px; cursor: pointer; font-size: 14px; transition: all 0.3s;">►</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Game Over Screen -->
    <div class="game-over" id="gameOver">
        <div style="max-width: 95vw; width: 100%; max-height: 95vh; display: flex; flex-direction: column; padding: 10px; box-sizing: border-box;">

            <!-- Título GAME OVER -->
            <div style="text-align: center; margin-bottom: 12px;">
                <h1 style="font-family: 'Orbitron', sans-serif; font-size: clamp(32px, 6vw, 48px); background: linear-gradient(45deg, #ff0055, #ff00ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin: 0; text-shadow: 0 0 30px #ff0055, 0 0 60px #ff00ff; letter-spacing: 4px; animation: title-glow 2s ease-in-out infinite;">GAME OVER</h1>
            </div>

            <!-- Botones de acción -->
            <div style="display: flex; gap: 8px; justify-content: center; margin-bottom: 12px; flex-wrap: wrap;">
                <button class="btn-game-over-primary" onclick="vibrateButton(50); location.reload()" style="
                    background: linear-gradient(135deg, #00ffff, #00cccc);
                    border: 2px solid #00ffff;
                    color: #000;
                    padding: 10px 20px;
                    border-radius: 8px;
                    font-size: clamp(12px, 2.5vw, 16px);
                    font-weight: 700;
                    cursor: pointer;
                    font-family: 'Orbitron', sans-serif;
                    text-transform: uppercase;
                    box-shadow: 0 0 20px rgba(0,255,255,0.5);
                    transition: all 0.3s ease;
                    flex: 1;
                    min-width: 120px;
                    max-width: 200px;
                ">▶ PLAY AGAIN</button>

                <button id="continueWithAdBtn" onclick="vibrateButton(50); if(typeof window.showAdForContinue === 'function') window.showAdForContinue();" style="
                    background: linear-gradient(135deg, #FFD700, #FFA500);
                    border: 2px solid #FFD700;
                    color: #000;
                    padding: 10px 20px;
                    border-radius: 8px;
                    font-size: clamp(11px, 2.2vw, 14px);
                    font-weight: 700;
                    cursor: pointer;
                    font-family: 'Orbitron', sans-serif;
                    text-transform: uppercase;
                    box-shadow: 0 0 20px rgba(255,215,0,0.5);
                    transition: all 0.3s ease;
                    flex: 1;
                    min-width: 140px;
                    max-width: 250px;
                    line-height: 1.2;
                ">RESTORE 25% HP<br><span style="font-size: 0.85em; opacity: 0.9;">(WATCH AD)</span></button>
            </div>

            <!-- Stats principales (Wave y Score) -->
            <div style="display: flex; gap: 10px; justify-content: center; margin-bottom: 12px;">
                <div style="
                    background: linear-gradient(135deg, rgba(0,255,255,0.1), rgba(0,255,255,0.05));
                    border: 2px solid rgba(0,255,255,0.4);
                    border-radius: 10px;
                    padding: 8px 16px;
                    text-align: center;
                    box-shadow: 0 0 20px rgba(0,255,255,0.3);
                    flex: 1;
                    max-width: 200px;
                ">
                    <div style="font-family: 'Orbitron', sans-serif; font-size: clamp(10px, 2vw, 13px); color: #00ffff; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 1px;">Wave Reached</div>
                    <div style="font-family: 'Orbitron', sans-serif; font-size: clamp(24px, 5vw, 36px); color: #fff; font-weight: 700; text-shadow: 0 0 10px #00ffff;" id="finalWave">0</div>
                </div>

                <div style="
                    background: linear-gradient(135deg, rgba(255,0,255,0.1), rgba(255,0,255,0.05));
                    border: 2px solid rgba(255,0,255,0.4);
                    border-radius: 10px;
                    padding: 8px 16px;
                    text-align: center;
                    box-shadow: 0 0 20px rgba(255,0,255,0.3);
                    flex: 1;
                    max-width: 200px;
                ">
                    <div style="font-family: 'Orbitron', sans-serif; font-size: clamp(10px, 2vw, 13px); color: #ff00ff; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 1px;">Final Score</div>
                    <div style="font-family: 'Orbitron', sans-serif; font-size: clamp(24px, 5vw, 36px); color: #fff; font-weight: 700; text-shadow: 0 0 10px #ff00ff;" id="finalScore">0</div>
                </div>
            </div>

            <!-- Tabla de estadísticas actuales -->
            <div style="
                background: linear-gradient(135deg, rgba(0,255,255,0.08), rgba(255,0,255,0.08));
                border: 2px solid rgba(0,255,255,0.4);
                border-radius: 10px;
                padding: 10px;
                box-shadow: 0 0 30px rgba(0,255,255,0.3), inset 0 0 20px rgba(0,255,255,0.1);
                flex: 1;
                overflow-y: auto;
                min-height: 0;
            ">
                <h3 style="font-family: 'Orbitron', sans-serif; font-size: clamp(13px, 2.5vw, 16px); color: #00ffff; text-align: center; margin: 0 0 10px 0; text-shadow: 0 0 10px #00ffff; letter-spacing: 2px;">CURRENT STATS</h3>

                <div id="gameOverStatsGrid" style="
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
                    gap: 6px;
                    font-family: 'Rajdhani', sans-serif;
                ">
                    <!-- Stats will be injected here by JavaScript -->
                </div>
            </div>

        </div>
    </div>

    <!-- Aim Cursor (Mobile - shows shooting direction from joystick) -->
    <div class="aim-cursor" id="aimCursor">
        <div class="cursor-dot"></div>
        <div class="cursor-ring"></div>
    </div>

    <!-- Main Canvas - CRITICAL: GPU-accelerated layer -->
    <canvas id="gameCanvas" ></canvas>

        <script>
    // Variables globales para control de cámara en minimapa
    window.minimapCameraActive = false;
    window.minimapCameraTarget = { x: 0, y: 0 };
    window.minimapViewportRect = { x: 0, y: 0, width: 0, height: 0 };
    var minimapCanvas = document.getElementById('minimapCanvas');

    // ================= MINIMAP CAMERA TOUCH/MOUSE =================
    function setMinimapCameraFromEvent(e) {
        var minimapCanvas = document.getElementById('minimapCanvas');
        if (!minimapCanvas) {
            console.warn('⚠️ minimapCanvas not found');
            return;
        }

        const rect = minimapCanvas.getBoundingClientRect();
        let mx, my;
        if (e.touches && e.touches.length > 0) {
            mx = e.touches[0].clientX - rect.left;
            my = e.touches[0].clientY - rect.top;
        } else {
            mx = e.clientX - rect.left;
            my = e.clientY - rect.top;
        }

        const mapSystem = window.gameMapSystem || window.mapSystem;
        if (!mapSystem) {
            console.warn('⚠️ mapSystem not found');
            return;
        }

        // Convert minimap coords to map coords
        const mapX = Math.floor(mx * mapSystem.width / minimapCanvas.width);
        const mapY = Math.floor(my * mapSystem.height / minimapCanvas.height);
        window.minimapCameraTarget.x = mapX * mapSystem.tileSize + mapSystem.tileSize / 2;
        window.minimapCameraTarget.y = mapY * mapSystem.tileSize + mapSystem.tileSize / 2;
        window.minimapCameraActive = true;

        console.log('📍 MINIMAP CLICK:', {
            minimapCoords: { mx, my },
            minimapSize: { w: minimapCanvas.width, h: minimapCanvas.height },
            mapSize: { w: mapSystem.width, h: mapSystem.height },
            tileSize: mapSystem.tileSize,
            tileCoords: { x: mapX, y: mapY },
            worldTarget: { x: window.minimapCameraTarget.x, y: window.minimapCameraTarget.y },
            cameraActive: window.minimapCameraActive
        });
    }

    if (minimapCanvas) {
        // Touch events
        minimapCanvas.addEventListener('touchstart', function(e) {
            e.preventDefault();
            setMinimapCameraFromEvent(e);
        }, { passive: false });

        minimapCanvas.addEventListener('touchmove', function(e) {
            if (window.minimapCameraActive) {
                e.preventDefault();
                setMinimapCameraFromEvent(e);
            }
        }, { passive: false });

        minimapCanvas.addEventListener('touchend', function(e) {
            window.minimapCameraActive = false;
            console.log('📍 MINIMAP TOUCH END');
        });

        // Mouse events
        minimapCanvas.addEventListener('mousedown', function(e) {
            setMinimapCameraFromEvent(e);
        });

        minimapCanvas.addEventListener('mousemove', function(e) {
            if (window.minimapCameraActive && e.buttons) {
                setMinimapCameraFromEvent(e);
            }
        });

        minimapCanvas.addEventListener('mouseup', function(e) {
            window.minimapCameraActive = false;
            console.log('📍 MINIMAP MOUSE UP');
        });

        minimapCanvas.addEventListener('mouseleave', function(e) {
            window.minimapCameraActive = false;
        });
    }
    // --- LOGIN CON GOOGLE Y GESTIÓN DE USUARIO ---
    // NOTA: Variables ahora definidas en config.js y firebase-handler.js
    // Mantener referencias locales para compatibilidad
    let currentUser = window.firebaseHandler?.currentUser || null;
    let maxLevelReached = window.firebaseHandler?.maxLevelReached || 1;
    window.isGuestMode = window.firebaseHandler?.isGuestMode || false;

    // Firebase references (ahora inicializadas por firebase-handler.js)
    let auth = null;
    let db = null;

    // Variable para rastrear el inicio de partida
    let gameStartTime = null;

    // --- AVATAR SYSTEM ---
    // NOTA: AVATAR_CONFIG ahora está en config.js
    let selectedAvatarIndex = null;
    let currentAvatarData = null;

    // Función para generar un avatar aleatorio del primer charset
    function getRandomAvatar() {
        const firstCharset = AVATAR_CONFIG.charsets[0]; // Solo del primer charset desbloqueado
        const totalAvatars = firstCharset.cols * firstCharset.rows;
        const randomIndex = Math.floor(Math.random() * totalAvatars);

        return {
            charsetId: firstCharset.id,
            index: randomIndex,
            row: Math.floor(randomIndex / firstCharset.cols),
            col: randomIndex % firstCharset.cols
        };
    }

    // Función para convertir datos de avatar a URL de imagen (usando canvas)
    function getAvatarImageURL(avatarData) {
        const charset = AVATAR_CONFIG.charsets.find(c => c.id === avatarData.charsetId);
        if (!charset) return 'settings-icons/default-avatar.png';

        // Canvas con alta calidad para renderizado circular
        const canvas = document.createElement('canvas');
        const size = AVATAR_CONFIG.tileSize;
        canvas.width = size;
        canvas.height = size;
        const ctx = canvas.getContext('2d', { alpha: true });

        // Configurar para renderizado de alta calidad
        ctx.imageSmoothingEnabled = true;
        ctx.imageSmoothingQuality = 'high';

        const img = new Image();
        img.src = charset.file;

        return new Promise((resolve) => {
            img.onload = () => {
                // Limpiar canvas con transparencia
                ctx.clearRect(0, 0, size, size);

                // Extraer tile del sprite sheet
                const sx = avatarData.col * size;
                const sy = avatarData.row * size;

                // Dibujar con alta calidad
                ctx.drawImage(img, sx, sy, size, size, 0, 0, size, size);

                // Convertir a dataURL con máxima calidad
                resolve(canvas.toDataURL('image/png', 1.0));
            };
            img.onerror = () => {
                resolve('settings-icons/default-avatar.png');
            };
        });
    }

    // Función para cargar el avatar del usuario desde Firestore
    async function loadUserAvatar(userId) {
        try {
            const userDoc = await db.collection('users').doc(userId).get();
            if (userDoc.exists && userDoc.data().avatar) {
                currentAvatarData = userDoc.data().avatar;
            } else {
                // Si no tiene avatar, asignar uno aleatorio
                currentAvatarData = getRandomAvatar();
                await db.collection('users').doc(userId).set({
                    avatar: currentAvatarData
                }, { merge: true });
            }

            // Actualizar la UI con el avatar
            await updateAvatarUI();
        } catch (error) {
            console.error('Error loading avatar:', error);
            // Fallback: avatar aleatorio
            currentAvatarData = getRandomAvatar();
            await updateAvatarUI();
        }
    }

    // Función para actualizar la UI con el avatar actual
    async function updateAvatarUI() {
        if (!currentAvatarData) return;

        const avatarURL = await getAvatarImageURL(currentAvatarData);

        // Actualizar todos los lugares donde aparece el avatar
        const userAvatar = document.getElementById('userAvatar');
        const modalUserAvatar = document.getElementById('modalUserAvatar');

        if (userAvatar) userAvatar.src = avatarURL;
        if (modalUserAvatar) modalUserAvatar.src = avatarURL;
    }

    // Función para abrir el modal de selección de avatar
    function openAvatarSelectionModal() {
        const modal = document.getElementById('avatarSelectionModal');
        const avatarGrid = document.getElementById('avatarGrid');

        // Limpiar grid
        avatarGrid.innerHTML = '';

        // Crear arrays separados para avatares desbloqueados y bloqueados
        const unlockedAvatars = [];
        const lockedAvatars = [];

        // Recolectar todos los avatares
        AVATAR_CONFIG.charsets.forEach(charset => {
            const totalAvatars = charset.cols * charset.rows;

            for (let i = 0; i < totalAvatars; i++) {
                const row = Math.floor(i / charset.cols);
                const col = i % charset.cols;

                const avatarData = {
                    charset: charset,
                    index: i,
                    row: row,
                    col: col
                };

                if (charset.unlocked) {
                    unlockedAvatars.push(avatarData);
                } else {
                    lockedAvatars.push(avatarData);
                }
            }
        });

        // Función para crear elemento de avatar
        function createAvatarElement(avatarData, isLocked) {
            const { charset, index, row, col } = avatarData;
            const avatarDiv = document.createElement('div');
            avatarDiv.className = 'avatar-option';

            // Crear el background con la posición correcta del sprite
            const bgX = -(col * AVATAR_CONFIG.tileSize);
            const bgY = -(row * AVATAR_CONFIG.tileSize);
            avatarDiv.style.backgroundImage = `url('${charset.file}')`;
            avatarDiv.style.backgroundPosition = `${bgX}px ${bgY}px`;
            avatarDiv.style.backgroundSize = `${charset.cols * AVATAR_CONFIG.tileSize}px ${charset.rows * AVATAR_CONFIG.tileSize}px`;

            if (isLocked) {
                avatarDiv.classList.add('locked');
            } else {
                // Marcar como seleccionado si es el avatar actual
                if (currentAvatarData &&
                    currentAvatarData.charsetId === charset.id &&
                    currentAvatarData.index === index) {
                    avatarDiv.classList.add('selected');
                    selectedAvatarIndex = { charsetId: charset.id, index: index, row, col };
                }

                // Event listener para selección (solo para desbloqueados)
                avatarDiv.addEventListener('click', async function() {
                    vibrateButton(50); // ✅ Vibración al seleccionar avatar
                    if (!currentUser) return;

                    // Remover selección previa
                    document.querySelectorAll('.avatar-option.selected').forEach(el => {
                        el.classList.remove('selected');
                    });

                    // Seleccionar este avatar
                    this.classList.add('selected');
                    selectedAvatarIndex = { charsetId: charset.id, index: index, row, col };

                    // Guardar inmediatamente en Firestore
                    try {
                        await db.collection('users').doc(currentUser.uid).set({
                            avatar: selectedAvatarIndex
                        }, { merge: true });

                        // Actualizar localmente
                        currentAvatarData = selectedAvatarIndex;
                        await updateAvatarUI();

                        console.log('✅ Avatar updated successfully');

                        // Cerrar el modal automáticamente
                        closeAvatarSelectionModal();
                    } catch (error) {
                        console.error('❌ Error updating avatar:', error);
                        alert('Error al actualizar el avatar. Inténtalo de nuevo.');
                    }
                });
            }

            return avatarDiv;
        }

        // Primero agregar avatares desbloqueados
        unlockedAvatars.forEach(avatarData => {
            const avatarElement = createAvatarElement(avatarData, false);
            avatarGrid.appendChild(avatarElement);
        });

        // Luego agregar avatares bloqueados
        lockedAvatars.forEach(avatarData => {
            const avatarElement = createAvatarElement(avatarData, true);
            avatarGrid.appendChild(avatarElement);
        });

        modal.classList.add('active');
        modal.style.display = 'flex';
    }

    // Función para cerrar el modal de selección de avatar
    function closeAvatarSelectionModal() {
        const modal = document.getElementById('avatarSelectionModal');
        modal.classList.remove('active');
        modal.style.display = 'none';
        selectedAvatarIndex = null;
    }

    // Función para confirmar la selección de avatar
    async function confirmAvatarSelection() {
        if (!selectedAvatarIndex || !currentUser) return;

        try {
            // Guardar en Firestore
            await db.collection('users').doc(currentUser.uid).set({
                avatar: selectedAvatarIndex
            }, { merge: true });

            // Actualizar localmente
            currentAvatarData = selectedAvatarIndex;
            await updateAvatarUI();

            // Cerrar modal
            closeAvatarSelectionModal();

            console.log('✅ Avatar updated successfully');
        } catch (error) {
            console.error('❌ Error updating avatar:', error);
            alert('Error updating avatar. Please try again.');
        }
    }

    // Verificar sesión guardada al iniciar (ANTES del DOMContentLoaded)
    function checkSavedSession() {
      console.log('🔍 Checking localStorage for saved session...');
      console.log('🔍 localStorage available:', typeof localStorage !== 'undefined');

      try {
        const savedUser = localStorage.getItem('neonSurvivorUser');
        console.log('🔍 localStorage.getItem result:', savedUser ? 'DATA FOUND' : 'NULL');

        if (savedUser) {
          const userData = JSON.parse(savedUser);
          console.log('✅ Parsed user data:', {
            email: userData.email,
            displayName: userData.displayName,
            hasPhotoURL: !!userData.photoURL
          });

          currentUser = userData;
          window.isGuestMode = false;
          return true;
        } else {
          console.log('⚠️ No saved session found in localStorage');
        }
      } catch (e) {
        console.error('❌ Error in checkSavedSession:', e);
        try {
          localStorage.removeItem('neonSurvivorUser');
        } catch (cleanupError) {
          console.error('❌ Error cleaning up localStorage:', cleanupError);
        }
      }
      return false;
    }

    // Intentar restaurar sesión guardada INMEDIATAMENTE
    const sessionRestored = checkSavedSession();
    console.log('🔍 Session restoration result:', sessionRestored);
    if (currentUser) {
      console.log('✅ currentUser set:', currentUser.email);
    }

    // Esperar a que el DOM esté completamente cargado
    document.addEventListener('DOMContentLoaded', function() {
        console.log('🚀 DOM loaded, initializing app...');

        // Wait for Firebase to be ready
        const waitForFirebase = setInterval(() => {
            if (auth && db) {
                clearInterval(waitForFirebase);
                initializeApp();
            }
        }, 100);

        function initializeApp() {
            console.log('🔥 Firebase ready, initializing app...');

    // Elementos del DOM
    const startMenu = document.getElementById('startMenu');
    const loginContainer = document.getElementById('loginContainer');
    const userMenuContainer = document.getElementById('userMenuContainer');
    const googleSignInBtn = document.getElementById('googleSignInBtn');
    const guestPlayBtn = document.getElementById('guestPlayBtn');
    const startGameBtn = document.getElementById('startGameBtn');
    const loadingScreen = document.getElementById('loadingScreen');
    const guestIndicator = document.getElementById('guestIndicator');
    const loginBtn = document.getElementById('loginBtn');

    // Si se restauró la sesión, actualizar UI
    if (sessionRestored && currentUser) {
        console.log('✅ Restoring UI for saved user:', currentUser.email);
        showUserMenu(currentUser);
        loadUserProgress(currentUser.uid);
        loadingScreen.style.display = 'none';

        // NO configurar listener de Firebase si ya tenemos sesión restaurada
        // El usuario ya está autenticado localmente
        console.log('ℹ️ Skipping Firebase auth listener - using restored session');
    } else {
        // Solo configurar listener si NO hay sesión restaurada
        console.log('ℹ️ Setting up Firebase auth listener...');
        // Solo configurar listener si NO hay sesión restaurada
        console.log('ℹ️ Setting up Firebase auth listener...');
      auth.onAuthStateChanged(user => {
        if (user) {
          currentUser = user;
          window.isGuestMode = false;

          // Guardar sesión en localStorage
          const userToSave = {
            uid: user.uid,
            displayName: user.displayName,
            email: user.email,
            photoURL: user.photoURL
          };
          localStorage.setItem('neonSurvivorUser', JSON.stringify(userToSave));

          showUserMenu(user);
          loadUserProgress(user.uid);
        } else {
          showLoginButton();
        }

        // Ocultar pantalla de carga cuando Firebase esté listo
        if (loadingScreen) {
            loadingScreen.style.display = 'none';
        }
      });
    } // Fin del if-else de sessionRestored

    // Login con Google
    googleSignInBtn.onclick = function() {
      console.log('🔐 Initiating Google Sign-In...');
      if (window.firebaseHandler && typeof window.firebaseHandler.signInWithGoogle === 'function') {
        window.firebaseHandler.signInWithGoogle();
      } else {
        console.error('❌ firebaseHandler.signInWithGoogle not available');
      }
    };

    // Manejar resultado del redirect de Google Sign-In
    auth.getRedirectResult().then(result => {
      if (result.user) {
        const user = result.user;
        currentUser = user;
        window.isGuestMode = false; // No es invitado
        // Datos básicos
        const profile = {
          uid: user.uid,
          nombre: user.displayName || '',
          email: user.email || '',
          foto: user.photoURL || '',
          fechaRegistro: firebase.firestore.Timestamp.now(),
          ultimaConexion: firebase.firestore.Timestamp.now()
        };
        db.collection("usuarios").doc(user.uid).set(profile, { merge: true });
        showUserMenu(user);
        loadUserProgress(user.uid);
      }
    }).catch(error => {
      console.error('Error en login:', error);
      alert('Error al iniciar sesión: ' + error.message);
    });

    // Callback para login nativo de Android (exitoso)
    window.onNativeAuthSuccess = function(userData) {
      console.log('✅ Native auth success:', userData);

      // El usuario ya está autenticado en Firebase Auth nativo
      // Solo necesitamos actualizar la UI con los datos recibidos
      currentUser = {
        uid: userData.uid,
        displayName: userData.displayName,
        email: userData.email,
        photoURL: userData.photoURL || ''
      };

      console.log('💾 Attempting to save session to localStorage...');
      console.log('💾 Data to save:', JSON.stringify(currentUser));

      try {
        // Guardar sesión en localStorage para persistencia
        localStorage.setItem('neonSurvivorUser', JSON.stringify(currentUser));
        console.log('✅ Session saved to localStorage successfully');

        // Verificar que se guardó correctamente
        const verification = localStorage.getItem('neonSurvivorUser');
        console.log('🔍 Verification read:', verification ? 'SUCCESS' : 'FAILED');
      } catch (e) {
        console.error('❌ Error saving to localStorage:', e);
      }

      window.isGuestMode = false;

      const profile = {
        uid: userData.uid,
        nombre: userData.displayName || '',
        email: userData.email || '',
        foto: userData.photoURL || '',
        fechaRegistro: firebase.firestore.Timestamp.now(),
        ultimaConexion: firebase.firestore.Timestamp.now()
      };

      db.collection("usuarios").doc(userData.uid).set(profile, { merge: true })
        .then(() => {
          console.log('✅ User profile saved to Firestore');
          showUserMenu(currentUser);
          loadUserProgress(userData.uid);
        })
        .catch(error => {
          console.error('❌ Error saving user profile:', error);
          // Mostrar UI de todos modos
          showUserMenu(currentUser);
          loadUserProgress(userData.uid);
        });
    };

    // Callback para login nativo de Android (error)
    window.onNativeAuthResult = function(success, message) {
      if (!success) {
        console.error('❌ Native auth error:', message);
        alert('Error al iniciar sesión: ' + message);
      }
    };

    // Jugar como invitado
    guestPlayBtn.onclick = function() {
      window.isGuestMode = true;
      currentUser = null;
      maxLevelReached = 1; // Invitados empiezan desde nivel 1
      showUserMenu({ displayName: 'Guest Player' });
    };

    // Login desde modo invitado
    loginBtn.onclick = function() {
      window.isGuestMode = false;
      currentUser = null;
      showLoginButton();
    };

    // Mostrar botón de login
    function showLoginButton() {
      loginContainer.style.display = 'block';
      userMenuContainer.style.display = 'none';
    }

    // Mostrar menú de usuario
    function showUserMenu(user) {
      loginContainer.style.display = 'none';
      userMenuContainer.style.display = 'block';


            // Re-attach click event to userAvatar (profile card)
            const userAvatar = document.getElementById('userAvatar');
            if (userAvatar) {
                userAvatar.style.cursor = 'pointer';
                userAvatar.onclick = showUserOptionsModal;
            }

            // Update avatar UI after login/logout
            updateAvatarUI();

            if (window.isGuestMode) {
                // Modo invitado
                document.getElementById('userName').textContent = 'Guest Player';
                document.getElementById('userAvatar').src = 'guest_user_logo.png';
                document.getElementById('userAvatar').alt = 'Guest Avatar';
                guestIndicator.style.display = 'inline-flex';
                loginBtn.style.display = 'flex';
                if (window.showUserBestScore) {
                        window.showUserBestScore(0);
                }
            } else {
                // Usuario logueado
                document.getElementById('userName').textContent = user.displayName || 'Player';
                loadUserAvatar(user.uid);
                guestIndicator.style.display = 'none';
                loginBtn.style.display = 'none';
                loadBestScore(user.uid);
            }

      // Actualizar visibilidad del botón de logout
      if (typeof updateLogoutButtonVisibility === 'function') {
          updateLogoutButtonVisibility();
      }
    }

    // Cargar mejor puntuación del usuario
    function loadBestScore(uid) {
      db.collection("ranking")
        .where("userId", "==", uid)
        .orderBy("score", "desc")
        .limit(1)
        .get()
        .then(snapshot => {
          if (!snapshot.empty) {
            const bestScore = snapshot.docs[0].data().score || 0;
            if (window.showUserBestScore) {
                window.showUserBestScore(bestScore);
            }
          } else {
            if (window.showUserBestScore) {
                window.showUserBestScore(0);
            }
          }
        })
        .catch(error => {
          console.error('Error loading best score:', error);
          if (window.showUserBestScore) {
              window.showUserBestScore(0);
          }
        });
    }

    // Cargar progreso del usuario
    function loadUserProgress(uid) {
      db.collection("usuarios").doc(uid).collection("partidas")
        .orderBy("wave", "desc")
        .limit(1)
        .get()
        .then(snapshot => {
          if (!snapshot.empty) {
            const lastGame = snapshot.docs[0].data();
            maxLevelReached = lastGame.wave || 1;
          }
        });
    }

    // ==================== MAP SELECTOR MODAL ====================
    const mapSelectorModal = document.getElementById('mapSelectorModal');
    const mapTypesGrid = document.getElementById('mapTypesGrid');
    const mapSelectorCancelBtn = document.getElementById('mapSelectorCancelBtn');
    const mapSelectorStartBtn = document.getElementById('mapSelectorStartBtn');
    let selectedMapType = 'maze'; // Default

    // Abrir modal de selección de mapa
    startGameBtn.onclick = function() {
        vibrateButton(30);
        mapSelectorModal.classList.add('active');
        // Seleccionar el primer tipo por defecto
        const firstCard = mapTypesGrid.querySelector('.map-type-card');
        if (firstCard) {
            firstCard.classList.add('selected');
            selectedMapType = firstCard.getAttribute('data-map-type');
        }
    };

    // Selección de tipo de mapa
    mapTypesGrid.addEventListener('click', function(e) {
        const card = e.target.closest('.map-type-card');
        if (card) {
            vibrateButton(20);
            // Remover selección anterior
            mapTypesGrid.querySelectorAll('.map-type-card').forEach(c => c.classList.remove('selected'));
            // Seleccionar nueva
            card.classList.add('selected');
            selectedMapType = card.getAttribute('data-map-type');
            console.log('🗺️ Map type selected:', selectedMapType);
        }
    });

    // Cancelar selección
    mapSelectorCancelBtn.onclick = function() {
        vibrateButton(20);
        mapSelectorModal.classList.remove('active');
    };

    // Iniciar juego con mapa seleccionado
    mapSelectorStartBtn.onclick = function() {
        vibrateButton(30);
        mapSelectorModal.classList.remove('active');
        console.log('🎮 Starting game with map type:', selectedMapType);
        startGame(1, selectedMapType);
    };

    // ==================== GAME START ====================
    // MAP TEST - Demostración del sistema de mapas procedurales
    const mapTestBtn = document.getElementById('mapTestBtn');
    if (mapTestBtn) {
        mapTestBtn.onclick = function() {
            console.log('🗺️ Starting Map System Test...');
            vibrateButton(30);
            // Ocultar menú
            startMenu.classList.add('hidden');

            // Obtener el canvas principal correctamente
            const canvas = document.getElementById('gameCanvas');
            if (!canvas) {
                alert('No se encontró el canvas principal.');
                return;
            }
            const ctx = canvas.getContext('2d');

            // Obtener minimapa
            const minimapCanvas = document.getElementById('minimapCanvas');
            const minimapCtx = minimapCanvas ? minimapCanvas.getContext('2d') : null;

            // Mostrar minimapa
            if (minimapCanvas) {
                minimapCanvas.style.opacity = '0.92';
            }

            // Crear instancia del sistema de mapas
            const mapSystem = new MapSystem();
            mapSystem.init(canvas);

            // Generar mapa con diferentes algoritmos (prueba aleatoria)
            const algorithms = ['maze', 'rooms', 'cellular'];
            const randomAlgo = algorithms[Math.floor(Math.random() * algorithms.length)];

            console.log('🎲 Using algorithm:', randomAlgo);
            mapSystem.generateMap({ algorithm: randomAlgo });

            // Estado de la demo
            let demoActive = true;
            let playerX = canvas.width / 2;
            let playerY = canvas.height / 2;
            let playerVelX = 0;
            let playerVelY = 0;
            const playerRadius = 20;
            const playerSpeed = 5;

            // Posicionar jugador en spawn
            const spawnPos = mapSystem.getPlayerSpawnPosition();
            playerX = spawnPos.x;
            playerY = spawnPos.y;

            // Crear algunos enemigos de prueba
            const demoEnemies = [];
            for (let i = 0; i < 10; i++) {
                const enemySpawn = mapSystem.getRandomEnemySpawnPosition();
                demoEnemies.push({
                    x: enemySpawn.x,
                    y: enemySpawn.y,
                    health: 100
                });
            }

            // Controles táctiles simplificados
            const keys = { w: false, a: false, s: false, d: false };

            window.addEventListener('keydown', (e) => {
                if (e.key in keys) keys[e.key] = true;
            });
            window.addEventListener('keyup', (e) => {
                if (e.key in keys) keys[e.key] = false;
                if (e.key === 'Escape') {
                    demoActive = false;
                    startMenu.classList.remove('hidden');
                    // Ocultar minimapa
                    if (minimapCanvas) {
                        minimapCanvas.style.opacity = '0';
                    }
                }
            });

            // Loop de renderizado
            function mapDemoLoop() {
                if (!demoActive) return;

                // Input
                playerVelX = 0;
                playerVelY = 0;
                if (keys.w) playerVelY = -playerSpeed;
                if (keys.s) playerVelY = playerSpeed;
                if (keys.a) playerVelX = -playerSpeed;
                if (keys.d) playerVelX = playerSpeed;

                // Normalizar diagonal
                if (playerVelX !== 0 && playerVelY !== 0) {
                    const len = Math.sqrt(playerVelX ** 2 + playerVelY ** 2);
                    playerVelX = (playerVelX / len) * playerSpeed;
                    playerVelY = (playerVelY / len) * playerSpeed;
                }

                // Movimiento con colisiones
                const nextX = playerX + playerVelX;
                const nextY = playerY + playerVelY;

                const collisionX = mapSystem.checkCollision(nextX, playerY, playerRadius);
                if (!collisionX.collision) {
                    playerX = nextX;
                }

                const collisionY = mapSystem.checkCollision(playerX, nextY, playerRadius);
                if (!collisionY.collision) {
                    playerY = nextY;
                }

                // Actualizar cámara
                const zoom = window.getCameraZoom ? window.getCameraZoom() : 2.0;
                if (window.minimapCameraActive) {
                    // Usar updateCamera con suavizado rápido para animación fluida
                    mapSystem.updateCamera(window.minimapCameraTarget.x, window.minimapCameraTarget.y, canvas.width, canvas.height, true, zoom);
                    console.log('📷 CAMERA UPDATE (MINIMAP):', {
                        target: { x: window.minimapCameraTarget.x, y: window.minimapCameraTarget.y },
                        camera: { x: mapSystem.camera.x, y: mapSystem.camera.y },
                        canvasSize: { w: canvas.width, h: canvas.height },
                        zoom: zoom
                    });
                } else {
                    mapSystem.updateCamera(playerX, playerY, canvas.width, canvas.height, false, zoom);
                }

                // Calcular viewport rect para minimapa con zoom
                const scaleX = minimapCanvas.width / mapSystem.width;
                const scaleY = minimapCanvas.height / mapSystem.height;
                const zoomedWidth = (canvas.width * zoom) / mapSystem.tileSize;
                const zoomedHeight = (canvas.height * zoom) / mapSystem.tileSize;

                window.minimapViewportRect = {
                    x: (mapSystem.camera.x / mapSystem.tileSize) * scaleX,
                    y: (mapSystem.camera.y / mapSystem.tileSize) * scaleY,
                    width: zoomedWidth * scaleX,
                    height: zoomedHeight * scaleY
                };

                // Render
                ctx.fillStyle = '#0a0a1a';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                // Renderizar mapa
                mapSystem.render(ctx, mapSystem.camera.x, mapSystem.camera.y);

                // Renderizar enemigos de prueba
                for (const enemy of demoEnemies) {
                    const enemyScreenX = enemy.x - mapSystem.camera.x;
                    const enemyScreenY = enemy.y - mapSystem.camera.y;

                    ctx.fillStyle = '#ff00ff';
                    ctx.beginPath();
                    ctx.arc(enemyScreenX, enemyScreenY, 15, 0, Math.PI * 2);
                    ctx.fill();
                }

                // Renderizar jugador
                const screenX = playerX - mapSystem.camera.x;
                const screenY = playerY - mapSystem.camera.y;

                ctx.fillStyle = '#00ff88';
                ctx.beginPath();
                ctx.arc(screenX, screenY, playerRadius, 0, Math.PI * 2);
                ctx.fill();

                ctx.strokeStyle = '#00ffff';
                ctx.lineWidth = 3;
                ctx.stroke();

                // Renderizar minimapa
                if (minimapCtx) {
                    mapSystem.renderMinimap(
                        minimapCtx,
                        minimapCanvas.width,
                        minimapCanvas.height,
                        { x: playerX, y: playerY },
                        demoEnemies
                    );
                }

                // UI Info
                ctx.fillStyle = '#ffffff';
                ctx.font = '20px Arial';
                ctx.fillText(`Algorithm: ${randomAlgo}`, 20, 30);
                ctx.fillText(`Player: (${Math.floor(playerX)}, ${Math.floor(playerY)})`, 20, 60);
                ctx.fillText(`Enemies: ${demoEnemies.length}`, 20, 90);
                ctx.fillText(`Press ESC to exit`, 20, canvas.height - 20);

                // Check bush
                if (mapSystem.isInBush(playerX, playerY)) {
                    ctx.fillStyle = 'rgba(45, 80, 22, 0.7)';
                    ctx.fillRect(canvas.width - 200, 20, 180, 40);
                    ctx.fillStyle = '#00ff00';
                    ctx.fillText('🌿 IN COVER', canvas.width - 180, 45);
                }

                requestAnimationFrame(mapDemoLoop);
            }

            mapDemoLoop();

            console.log('✅ Map demo started - Use WASD to move, ESC to exit');
            console.log('📍 Minimapa activado en la esquina superior derecha');
        };
    }

    // Iniciar juego desde un nivel específico
        function startGame(startLevel, mapType = 'maze') {
            gameStartTime = Date.now(); // Registrar inicio de partida
            startMenu.classList.add('hidden');
            // loadingScreen.style.display = 'flex'; // Ya no se muestra loadingScreen en cada partida

            // Asegurar que el overlay de pausa esté oculto
            if (pauseOverlay) {
                pauseOverlay.style.display = 'none';
            }

            // Establecer wave inicial en el gameState
            if (window.gameState) {
                window.gameState.wave = startLevel;
            }

            // Guardar el tipo de mapa seleccionado globalmente
            window.selectedMapType = mapType;
            console.log('🗺️ Map type for game:', mapType);

            // Iniciar el juego inmediatamente (sin mostrar loadingScreen)
            if (window.startGameFromMenu) {
                window.startGameFromMenu(startLevel, mapType);
            }
        }

    // Guardar datos extra del usuario (llama a esta función cuando tengas los datos)
    function guardarDatosExtra(edad, sexo, region, pais, continente) {
        if (!currentUser) return;
        db.collection("usuarios").doc(currentUser.uid).set({
            edad, sexo, region, pais, continente,
            ultimaConexion: firebase.firestore.Timestamp.now()
        }, { merge: true });
    }

    // Guardar partida/score (llama a esta función al terminar una partida)
    function guardarPartida(score, wave, kills, endType = 'FINISHED') {
        if (!currentUser) return;

        const partidaData = {
            score: score,
            wave: wave,
            kills: kills,
            fecha: firebase.firestore.Timestamp.now(),
            duracion: Date.now() - gameStartTime, // Duración en milisegundos
            userId: currentUser.uid,
            userName: currentUser.displayName || 'Anonymous',
            endType: endType // 'FINISHED' o 'ABORTED'
        };

        // Guardar en colección de usuario
        db.collection("usuarios").doc(currentUser.uid)
            .collection("partidas").add(partidaData)
            .then(() => {
                console.log('✅ Partida guardada correctamente');

                // Actualizar máximo nivel alcanzado si es mayor
                if (wave > maxLevelReached) {
                    maxLevelReached = wave;
                    db.collection("usuarios").doc(currentUser.uid).set({
                        maxLevelReached: wave,
                        ultimaConexion: firebase.firestore.Timestamp.now()
                    }, { merge: true });
                }
            })
            .catch(error => {
                console.error('❌ Error guardando partida:', error);
            });

        // Guardar en colección global de ranking
        db.collection("ranking").add(partidaData)
            .then(() => {
                console.log('✅ Partida añadida al ranking global');
            })
            .catch(error => {
                console.error('❌ Error guardando en ranking global:', error);
            });
    }

    // Hacer la función global para que game.js pueda llamarla
    window.guardarPartida = guardarPartida;

    // ===================================
    // STATS & RANKING PAGE
    // ===================================

    const statsPage = document.getElementById('statsPage');
    const statsBtn = document.getElementById('statsBtn');
    const closeStatsBtn = document.getElementById('closeStatsBtn');
    const tabBtns = document.querySelectorAll('.stats-tabs .tab-btn');

    // Abrir página de stats
    statsBtn.onclick = function() {
        // Verificar si es invitado
        if (window.isGuestMode) {
            alert('🔒 Rankings only available for registered users!\n\n✨ Sign in with Google to:\n• Access daily, monthly, and all-time rankings\n• Save your progress across devices\n• See fewer ads and enjoy more gameplay!\n\nTap the "LOGIN WITH GOOGLE" button to get started.');
            return;
        }

        statsPage.classList.add('active');
        loadMyStats();
        loadRanking('daily-score');
        // --- LIMPIEZA Y PAUSA DEL JUEGO ---
        if (window.gameState) {
            window.gameState.isPlaying = false;
            window.gameState.isPaused = false;
            window.gameState.isGameOver = false;
        }
        if (window.enemies) window.enemies = [];
        if (window.bullets) window.bullets = [];
        if (window.particles) window.particles = [];
        if (window.audioContext && window.audioContext.state === 'running') {
            window.audioContext.suspend();
        }
    };

    // Cerrar página de stats
    closeStatsBtn.onclick = function() {
        statsPage.classList.remove('active');
    };

    // ===================================
    // LOGOUT BUTTON
    // ===================================

    // Show/hide logout button based on login state
    function updateLogoutButtonVisibility() {
        const logoutItem = document.getElementById('logoutItem');
        if (logoutItem) {
            if (window.isGuestMode || !currentUser) {
                logoutItem.style.display = 'none';
            } else {
                logoutItem.style.display = 'block';
            }
        }
    }

    // Logout handler setup
    const logoutBtnElement = document.getElementById('logoutBtn');
    if (logoutBtnElement) {
        logoutBtnElement.onclick = function() {
            if (confirm('¿Estás seguro de que quieres cerrar sesión?')) {
                auth.signOut().then(() => {
                    console.log('✅ User logged out successfully');
                    // Reset UI to login screen
                    document.getElementById('loginContainer').style.display = 'block';
                    document.getElementById('userMenuContainer').style.display = 'none';
                    currentUser = null;
                    window.isGuestMode = false;
                }).catch((error) => {
                    console.error('❌ Error logging out:', error);
                    alert('Error al cerrar sesión. Intenta de nuevo.');
                });
            }
        };
    }

    // ===================================
    // STATS & RANKING
    // ===================================

    // Tabs
    tabBtns.forEach(btn => {
        btn.onclick = function() {
            const tab = this.dataset.tab;
            const period = this.dataset.period;
            tabBtns.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            document.querySelectorAll('.stats-content').forEach(c => c.classList.remove('active'));
            document.getElementById(tab).classList.add('active');
            loadRanking(tab);
            loadMyStats(period);
        };
    });

    // Cargar mis estadísticas
    function loadMyStats() {
        // Accept period as argument, default to 'daily'
        let period = arguments.length > 0 ? arguments[0] : 'daily';
        if (!currentUser) return;
        const loadingDiv = document.getElementById('myStatsLoading');
        loadingDiv.style.display = 'block';
        document.getElementById('myStats').style.opacity = 0.5;

        let query = db.collection("ranking").where("userId", "==", currentUser.uid);
        const now = new Date();
        if (period === 'daily') {
            const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            query = query.where("fecha", ">=", firebase.firestore.Timestamp.fromDate(startOfDay));
        } else if (period === 'monthly') {
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 29);
            query = query.where("fecha", ">=", firebase.firestore.Timestamp.fromDate(startOfMonth));
        }

        query.get().then(snapshot => {
            let totalGames = 0;
            let bestScore = 0;
            let bestWave = 0;
            let totalKills = 0;

            snapshot.forEach(doc => {
                const data = doc.data();
                totalGames++;
                if (data.score > bestScore) bestScore = data.score;
                if (data.wave > bestWave) bestWave = data.wave;
                totalKills += data.kills || 0;
            });

            document.getElementById('totalGames').textContent = totalGames;
            document.getElementById('bestScore').textContent = bestScore.toLocaleString();
            document.getElementById('bestWave').textContent = bestWave;
            document.getElementById('totalKills').textContent = totalKills.toLocaleString();
        }).finally(() => {
            loadingDiv.style.display = 'none';
            document.getElementById('myStats').style.opacity = 1;
        });
    }
    // My Stats filter buttons event removed; unified with tabBtns

    // Cargar ranking según tab
    function loadRanking(tab) {
        // Mapear tabs a IDs correctos
        const tabMapping = {
            'daily-score': { tableId: 'dailyScoreTable', bodyId: 'dailyScoreBody', period: 'daily' },
            'monthly-score': { tableId: 'monthlyScoreTable', bodyId: 'monthlyScoreBody', period: 'monthly' },
            'alltime-score': { tableId: 'alltimeScoreTable', bodyId: 'alltimeScoreBody', period: 'alltime' }
        };

        const mapping = tabMapping[tab];
        if (!mapping) {
            console.error('Tab desconocido:', tab);
            return;
        }

        const { tableId, bodyId, period } = mapping;
        const loadingDiv = document.querySelector(`#${tab} .loading-stats`);
        const table = document.getElementById(tableId);

        // Mostrar loading
        if (loadingDiv) loadingDiv.style.display = 'block';
        if (table) table.style.display = 'none';

        let query = db.collection("ranking");
        const now = new Date();

        // Filtro por periodo y ordenar por score
        if (period === 'daily') {
            const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            query = query.where('fecha', '>=', firebase.firestore.Timestamp.fromDate(startOfDay))
                         .orderBy('fecha', 'desc')
                         .orderBy('score', 'desc');
        } else if (period === 'monthly') {
            const last30Days = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
            query = query.where('fecha', '>=', firebase.firestore.Timestamp.fromDate(last30Days))
                         .orderBy('fecha', 'desc')
                         .orderBy('score', 'desc');
        } else {
            // All-time: solo ordenar por score
            query = query.orderBy('score', 'desc');
        }

        // Obtener ranking completo
        query.limit(200).get()
            .then(snapshot => {
                const allResults = [];
                const userScores = {};

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const userId = data.userId;

                    // Solo guardar la mejor partida de cada usuario (por score)
                    if (!userScores[userId] || data.score > userScores[userId].score) {
                        userScores[userId] = data;
                    }
                });

                // Convertir a array y ordenar por score
                for (let userId in userScores) {
                    allResults.push(userScores[userId]);
                }
                allResults.sort((a, b) => b.score - a.score);

                // Encontrar posición del usuario actual
                let userRank = -1;
                if (currentUser) {
                    userRank = allResults.findIndex(r => r.userId === currentUser.uid);
                }

                // Determinar qué resultados mostrar (10 arriba, usuario, 10 abajo)
                let displayResults = [];
                if (userRank === -1 || allResults.length <= 21) {
                    displayResults = allResults.slice(0, 21);
                } else if (userRank < 10) {
                    displayResults = allResults.slice(0, 21);
                } else if (userRank > allResults.length - 11) {
                    displayResults = allResults.slice(-21);
                } else {
                    displayResults = allResults.slice(userRank - 10, userRank + 11);
                }

                // Ocultar loading y mostrar tabla
                if (loadingDiv) loadingDiv.style.display = 'none';
                if (table) table.style.display = 'table';

                renderRankingTable(displayResults, bodyId, tableId, allResults);
            })
            .catch(error => {
                console.error('Error cargando ranking:', error);
                if (loadingDiv) {
                    loadingDiv.innerHTML = `
                        <div style="color: #ff4757; text-align: center; padding: 20px;">
                            <div style="font-size: 1.2em; margin-bottom: 10px;">⚠️ Index Required</div>
                            <div style="font-size: 0.9em;">Firebase needs a composite index for this query.</div>
                            <a href="${error.message.match(/https:\/\/[^\s]+/)}" target="_blank"
                               style="display: inline-block; margin-top: 10px; color: #00d4ff; text-decoration: none;
                                      background: rgba(0,212,255,0.1); padding: 8px 16px; border-radius: 8px;">
                                Create Index
                            </a>
                        </div>
                    `;
                }
            });
    }

    // Renderizar tabla de ranking
    function renderRankingTable(results, bodyId, tableId, allResults) {
        const tbody = document.getElementById(bodyId);
        const table = document.getElementById(tableId);

        if (!tbody || !table) {
            console.error('No se encontraron elementos:', { bodyId, tableId });
            return;
        }

        tbody.innerHTML = '';

        if (results.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">No data available</td></tr>';
        } else {
            results.forEach((data, index) => {
                const actualRank = allResults.findIndex(r => r.userId === data.userId) + 1;
                const row = document.createElement('tr');
                if (currentUser && data.userId === currentUser.uid) {
                    row.classList.add('current-user');
                }

                let rankClass = '';
                if (actualRank === 1) rankClass = 'rank-gold';
                else if (actualRank === 2) rankClass = 'rank-silver';
                else if (actualRank === 3) rankClass = 'rank-bronze';

                row.innerHTML = `
                    <td><span class="rank-number ${rankClass}">#${actualRank}</span></td>
                    <td>${data.userName || 'Anonymous'}</td>
                    <td>${data.score.toLocaleString()}</td>
                    <td>${data.wave}</td>
                `;
                tbody.appendChild(row);
            });
        }

        table.style.display = 'table';
        table.previousElementSibling.style.display = 'none'; // Hide loading
    }

    // ==================== USER OPTIONS MODAL ====================

    // Referencias al modal
    const userOptionsModal = document.getElementById('userOptionsModal');
    const modalUserAvatar = document.getElementById('modalUserAvatar');
    const modalUserName = document.getElementById('modalUserName');
    const modalUserEmail = document.getElementById('modalUserEmail');
    const logoutModalBtn = document.getElementById('logoutModalBtn');
    const closeUserOptionsBtn = document.getElementById('closeUserOptionsBtn');
    const userAvatar = document.getElementById('userAvatar');

    // Función para mostrar el modal
    function showUserOptionsModal() {
        if (!currentUser) {
            console.log('No user logged in');
            return;
        }

        console.log('📋 Modal element:', userOptionsModal);
        console.log('📋 Modal computed style:', window.getComputedStyle(userOptionsModal).display);
        console.log('📋 Modal z-index:', window.getComputedStyle(userOptionsModal).zIndex);

        // Actualizar avatar con el personalizado si existe
        if (currentAvatarData) {
            getAvatarImageURL(currentAvatarData).then(url => {
                modalUserAvatar.src = url;
            });
        } else {
            modalUserAvatar.src = currentUser.photoURL || 'https://via.placeholder.com/80';
        }

        modalUserName.textContent = currentUser.displayName || 'Usuario';
        modalUserEmail.textContent = currentUser.email || '';

        // Mostrar modal con múltiples métodos para asegurar visibilidad
        userOptionsModal.style.display = 'flex';
        userOptionsModal.style.zIndex = '999999';
        userOptionsModal.classList.add('active');

        console.log('✅ Modal display set to:', userOptionsModal.style.display);
        console.log('✅ Modal classList:', userOptionsModal.classList.toString());
    }

    // Función para ocultar el modal
    function hideUserOptionsModal() {
        userOptionsModal.style.display = 'none';
        userOptionsModal.classList.remove('active');
    }

    // Event listener: Hacer clic en el avatar del usuario
    if (userAvatar) {
        userAvatar.style.cursor = 'pointer';
        userAvatar.addEventListener('click', (e) => {
            e.preventDefault();
            vibrateButton(50); // ✅ Vibración al abrir opciones de usuario
            console.log('🖱️ Avatar clicked, currentUser:', currentUser);
            console.log('🖱️ isGuestMode:', window.isGuestMode);
            if (currentUser && !window.isGuestMode) {
                console.log('✅ Showing user options modal...');
                showUserOptionsModal();
            } else {
                console.log('⚠️ Cannot show modal: guest mode or no user');
            }
        });
    } else {
        console.error('❌ userAvatar element not found!');
    }

    // Event listener: Botón de cerrar modal
    if (closeUserOptionsBtn) {
        closeUserOptionsBtn.addEventListener('click', () => {
            vibrateButton(50); // ✅ Vibración al cerrar
            hideUserOptionsModal();
        });
    }

    // Event listener: Hacer clic fuera del modal
    if (userOptionsModal) {
        userOptionsModal.addEventListener('click', (e) => {
            if (e.target === userOptionsModal) {
                vibrateButton(50); // ✅ Vibración al cerrar
                hideUserOptionsModal();
            }
        });
    }

    // Event listener: Botón de Logout
    if (logoutModalBtn) {
        logoutModalBtn.addEventListener('click', async () => {
            vibrateButton(50); // ✅ Vibración al hacer logout
            try {
                console.log('Logging out...');

                // Limpiar localStorage
                localStorage.removeItem('neonSurvivorUser');

                // Cerrar modal
                hideUserOptionsModal();

                // Llamar a signOut nativo de Android si está disponible
                if (typeof AndroidAdMob !== 'undefined' && typeof AndroidAdMob.signOut === 'function') {
                    AndroidAdMob.signOut();
                    console.log('✅ Native Android sign out called');
                }

                // Sign out de Firebase (web)
                await auth.signOut();
                console.log('✅ Firebase sign out successful');

                // Resetear currentUser
                currentUser = null;
                window.isGuestMode = false;

                // Actualizar UI para mostrar pantalla de login
                showLoginButton();

                // Mostrar mensaje de éxito (opcional)
                console.log('✅ Logout successful');

            } catch (error) {
                console.error('❌ Error during logout:', error);
                alert('Error al cerrar sesión: ' + error.message);
            }
        });
    }

    console.log('✅ User Options Modal initialized');

    // ==================== AVATAR SELECTION MODAL ====================

    const avatarSelectionModal = document.getElementById('avatarSelectionModal');

    // Event listener: Click en el avatar del modal para cambiar avatar
    if (modalUserAvatar) {
        modalUserAvatar.addEventListener('click', (e) => {
            e.stopPropagation(); // Evitar que cierre el modal de usuario
            vibrateButton(50); // ✅ Vibración al abrir selección de avatar
            if (currentUser && !window.isGuestMode) {
                console.log('🎨 Opening avatar selection modal...');
                openAvatarSelectionModal();
            }
        });
    }

    // Event listener: Hacer clic fuera del modal de avatar para cerrar
    if (avatarSelectionModal) {
        avatarSelectionModal.addEventListener('click', (e) => {
            if (e.target === avatarSelectionModal) {
                vibrateButton(50); // ✅ Vibración al cerrar
                closeAvatarSelectionModal();
            }
        });
    }

    console.log('✅ Avatar Selection Modal initialized');

    // Fin de initializeApp
    } // Cierre de initializeApp
    }); // Cierre de DOMContentLoaded

    </script>
    <script>
        // ===================================
        // MOBILE CURSOR REMOVED - No longer using custom PC cursor
        // ===================================

    const pauseOverlay = document.getElementById('pauseOverlay');
    const resumeBtn = document.getElementById('resumeBtn');
    const abortBtn = document.getElementById('abortBtn');

        // Function to update pause stats
        window.currentStatsPage = 1;
        window.STATS_PER_PAGE = 8; // Número de stats por página

        function updatePauseStats() {
            const pauseStatsGrid = document.getElementById('pauseStatsGrid');
            const pagination = document.getElementById('pauseStatsPagination');
            if (!pauseStatsGrid || !window.playerStats) return;

            const statNames = {
                movementSpeed: 'Speed',
                fireRate: 'Fire Rate',
                resilience: 'Armor',
                bulletDamage: 'Damage',
                maxHealth: 'Max HP',
                pickupMagnet: 'Magnet',
                criticalChance: 'Crit %',
                regeneration: 'Regen'
            };

            // Convertir stats a array para paginación
            const statsArray = Object.entries(window.playerStats);
            const totalPages = Math.ceil(statsArray.length / window.STATS_PER_PAGE);

            // Mostrar paginación solo si hay más de 8 stats y pantalla pequeña
            const needsPagination = window.innerHeight < 600 && totalPages > 1;
            if (pagination) {
                pagination.style.display = needsPagination ? 'flex' : 'none';
            }

            // Calcular índices para la página actual
            const startIdx = needsPagination ? (window.currentStatsPage - 1) * window.STATS_PER_PAGE : 0;
            const endIdx = needsPagination ? startIdx + window.STATS_PER_PAGE : statsArray.length;
            const pageStats = statsArray.slice(startIdx, endIdx);

            pauseStatsGrid.innerHTML = '';

            pageStats.forEach(([key, stat]) => {
                const statCard = document.createElement('div');
                statCard.style.cssText = `
                    background: linear-gradient(135deg, rgba(0,255,255,0.1), rgba(255,0,255,0.05));
                    border: 1px solid rgba(0,255,255,0.3);
                    border-radius: 8px;
                    padding: 6px 8px;
                    text-align: center;
                    transition: all 0.3s ease;
                    box-shadow: 0 0 10px rgba(0,255,255,0.2);
                    cursor: default;
                `;

                // Hover effect
                statCard.onmouseenter = () => {
                    statCard.style.borderColor = 'rgba(0,255,255,0.8)';
                    statCard.style.boxShadow = '0 0 20px rgba(0,255,255,0.5)';
                    statCard.style.transform = 'scale(1.05)';
                };
                statCard.onmouseleave = () => {
                    statCard.style.borderColor = 'rgba(0,255,255,0.3)';
                    statCard.style.boxShadow = '0 0 10px rgba(0,255,255,0.2)';
                    statCard.style.transform = 'scale(1)';
                };

                let displayValue;
                if (key === 'fireRate') {
                    displayValue = Math.round(stat.currentValue) + 'ms';
                } else if (key === 'criticalChance') {
                    displayValue = (stat.currentValue * 100).toFixed(0) + '%';
                } else if (key === 'resilience') {
                    displayValue = ((1 - stat.currentValue) * 100).toFixed(0) + '%';
                } else if (key === 'regeneration') {
                    displayValue = stat.currentValue.toFixed(1) + '/s';
                } else if (key === 'pickupMagnet') {
                    displayValue = Math.round(stat.currentValue);
                } else {
                    displayValue = stat.currentValue.toFixed(1);
                }

                statCard.innerHTML = `
                    <div style="font-size: clamp(9px, 1.8vw, 11px); color: #00ffff; margin-bottom: 2px; text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px;">${statNames[key] || key}</div>
                    <div style="font-size: clamp(16px, 3.5vw, 20px); color: #fff; font-weight: 700; text-shadow: 0 0 8px #00ffff; line-height: 1.2;">${displayValue}</div>
                    <div style="font-size: clamp(9px, 1.6vw, 10px); color: #ff00ff; margin-top: 2px; opacity: 0.9;">Lv.${stat.level}</div>
                `;

                pauseStatsGrid.appendChild(statCard);
            });

            // Actualizar indicador de página
            if (needsPagination) {
                const pageIndicator = document.getElementById('pageIndicator');
                if (pageIndicator) {
                    pageIndicator.textContent = `${window.currentStatsPage} / ${totalPages}`;
                }

                // Botones de navegación
                const prevBtn = document.getElementById('prevPageBtn');
                const nextBtn = document.getElementById('nextPageBtn');

                if (prevBtn) {
                    prevBtn.disabled = window.currentStatsPage === 1;
                    prevBtn.style.opacity = window.currentStatsPage === 1 ? '0.3' : '1';
                    prevBtn.style.cursor = window.currentStatsPage === 1 ? 'not-allowed' : 'pointer';
                }

                if (nextBtn) {
                    nextBtn.disabled = window.currentStatsPage === totalPages;
                    nextBtn.style.opacity = window.currentStatsPage === totalPages ? '0.3' : '1';
                    nextBtn.style.cursor = window.currentStatsPage === totalPages ? 'not-allowed' : 'pointer';
                }
            }
        }

        // Navegación de páginas
        const prevPageBtn = document.getElementById('prevPageBtn');
        const nextPageBtn = document.getElementById('nextPageBtn');

        if (prevPageBtn) {
            prevPageBtn.addEventListener('click', () => {
                vibrateButton(50); // ✅ Vibración al cambiar página
                if (window.currentStatsPage > 1) {
                    window.currentStatsPage--;
                    updatePauseStats();
                }
            });
        }

        if (nextPageBtn) {
            nextPageBtn.addEventListener('click', () => {
                vibrateButton(50); // ✅ Vibración al cambiar página
                const statsArray = Object.entries(window.playerStats || {});
                const totalPages = Math.ceil(statsArray.length / window.STATS_PER_PAGE);
                if (window.currentStatsPage < totalPages) {
                    window.currentStatsPage++;
                    updatePauseStats();
                }
            });
        }

        // Export function globally
        window.updatePauseStats = updatePauseStats;

        if (resumeBtn) {
            resumeBtn.addEventListener('click', () => {
                vibrateButton(50); // ✅ Vibración al resumir
                if (window.gameState && window.gameState.isPaused) {
                    window.gameState.isPaused = false;
                    if (pauseOverlay) pauseOverlay.style.display = 'none';
                    const hud = document.getElementById('gameHUD');
                    if (hud) hud.style.opacity = '1';
                }
            });
        }

        // Botón abandonar partida
        if (abortBtn) {
            abortBtn.addEventListener('click', () => {
                vibrateButton(70); // ✅ Vibración más fuerte para acción destructiva
                if (window.gameState && window.gameState.isPlaying && !window.gameState.isGameOver) {
                    // Guardar la partida como ABORTED
                    if (typeof window.guardarPartida === 'function') {
                        window.guardarPartida(window.gameState.score, window.gameState.wave, window.gameState.kills, 'ABORTED');
                    }

                    // Resetear completamente el estado del juego
                    if (typeof window.resetGameState === 'function') {
                        window.resetGameState();
                    }

                    // Ocultar overlay de pausa
                    if (pauseOverlay) pauseOverlay.style.display = 'none';

                    // Ocultar HUD
                    const hud = document.getElementById('gameHUD');
                    if (hud) hud.classList.remove('active');

                    // Mostrar menú principal
                    const startMenu = document.getElementById('startMenu');
                    if (startMenu) startMenu.classList.remove('hidden');
                }
            });
        }

        // ESC key toggles pause
        function togglePause() {
            if (!window.gameState || !window.gameState.isPlaying || window.gameState.isGameOver) return;

            window.gameState.isPaused = !window.gameState.isPaused;
            const pauseOverlay = document.getElementById('pauseOverlay');
            const hud = document.getElementById('gameHUD');

            if (window.gameState.isPaused) {
                // Mostrar menú de pausa
                if (pauseOverlay) pauseOverlay.style.display = 'flex';
                if (hud) hud.style.opacity = '0.5';

                // Reset page to 1 when opening pause menu
                if (typeof window.currentStatsPage !== 'undefined') {
                    window.currentStatsPage = 1;
                }

                // Update pause stats
                if (typeof window.updatePauseStats === 'function') {
                    window.updatePauseStats();
                }
            } else {
                // Ocultar menú de pausa
                if (pauseOverlay) pauseOverlay.style.display = 'none';
                if (hud) hud.style.opacity = '1';
            }
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                togglePause();
            }
        });

        // ===================================
        // UPGRADE MODAL SYSTEM
        // ===================================

        const upgradeModal = document.getElementById('upgradeModal');
        const xpBar = document.getElementById('xpBar');
        const xpText = document.getElementById('xpText');
        const xpEarnedText = document.getElementById('xpEarnedText');
        const enemyXpBreakdown = document.getElementById('enemyXpBreakdown');
        const upgradesGrid = document.getElementById('upgradesGrid');
        const undoUpgradesBtn = document.getElementById('undoUpgradesBtn');
        const acceptUpgradesBtn = document.getElementById('acceptUpgradesBtn');

        // Iconos para cada tipo de enemigo
        const enemyIcons = {
            normal: '🟢',
            fast: '⚡',
            heavy: '🔴',
            superheavy: '💀',
            explosive: '💣',
            boss: '👑'
        };

        // Nombres para cada tipo
        const enemyNames = {
            normal: 'Normal',
            fast: 'Fast',
            heavy: 'Heavy',
            superheavy: 'Super Heavy',
            explosive: 'Explosive',
            boss: 'Boss'
        };


        // Nombres bonitos para las stats
        const statNames = {
            movementSpeed: 'Movement Speed',
            fireRate: 'Fire Rate',
            resilience: 'Resilience',
            bulletDamage: 'Bullet Damage',
            maxHealth: 'Max Health',
            pickupMagnet: 'Pickup Magnet',
            criticalChance: 'Critical Chance',
            regeneration: 'Regeneration'
        };

        // Mostrar modal de upgrades
        window.showUpgradeModal = function() {
            console.log('📊 showUpgradeModal called!');
            if (!window.gameState || !window.playerStats) {
                console.error('❌ Game state or player stats not found');
                return;
            }

            // Crear snapshot antes de mostrar el modal
            if (typeof window.createStatsSnapshot === 'function') {
                window.createStatsSnapshot();
            }

            // Actualizar barra de XP
            updateXPBar();

            // Actualizar UI del bonus
            updateUpgradeModalBonusUI();

            // Renderizar tabla de upgrades
            renderUpgradesGrid();

            // Mostrar modal
            upgradeModal.classList.add('active');
        };

        // Actualizar UI del bonus de anuncio
        function updateUpgradeModalBonusUI() {
            const watchAdBtn = document.getElementById('watchAdBtn');
            const bonusActiveIndicator = document.getElementById('bonusActiveIndicator');
            const adBonusSection = document.getElementById('adBonusSection');

            if (!watchAdBtn || !bonusActiveIndicator || !adBonusSection) {
                console.warn('⚠️ Ad bonus UI elements not found');
                return;
            }

            const bonusState = window.adBonusState;

            // Verificar si bonusState existe y está inicializado
            if (!bonusState) {
                console.warn('⚠️ adBonusState not initialized yet, hiding ad section');
                adBonusSection.style.display = 'none';
                return;
            }

            console.log('🎁 Updating bonus UI - active:', bonusState.active, 'canWatch:', bonusState.canWatch);

            if (bonusState.active) {
                // Bonus activo (anuncio visto, esperando a ser usado) - mostrar indicador
                watchAdBtn.style.display = 'none';
                bonusActiveIndicator.style.display = 'block';
                adBonusSection.style.display = 'block';
                console.log('✅ Showing active bonus indicator');
            } else if (bonusState.canWatch) {
                // Puede ver un anuncio - mostrar botón
                watchAdBtn.style.display = 'inline-block';
                bonusActiveIndicator.style.display = 'none';
                adBonusSection.style.display = 'block';
                console.log('✅ Showing watch ad button');
            } else {
                // No puede ver anuncio porque ya hay uno pendiente de consumir
                adBonusSection.style.display = 'none';
                console.log('⚠️ Hiding ad section - cannot watch (bonus pending consumption)');
            }
        }

        // Exponer función globalmente
        window.updateUpgradeModalBonusUI = updateUpgradeModalBonusUI;

        // Event listener para el botón de ver anuncio
        const watchAdBtn = document.getElementById('watchAdBtn');
        if (watchAdBtn) {
            watchAdBtn.addEventListener('click', () => {
                vibrateButton(50); // ✅ Vibración al solicitar anuncio
                console.log('📺 Watch Ad button clicked');
                if (typeof window.activateTripleBonus === 'function') {
                    window.activateTripleBonus();
                }
            });

            // Efecto hover
            watchAdBtn.addEventListener('mouseenter', function() {
                this.style.transform = 'scale(1.05)';
                this.style.boxShadow = '0 0 30px rgba(255,215,0,0.8)';
            });
            watchAdBtn.addEventListener('mouseleave', function() {
                this.style.transform = 'scale(1)';
                this.style.boxShadow = '0 0 20px rgba(255,215,0,0.5)';
            });
        }

        // Actualizar barra de XP
        function updateXPBar() {
            const currentXP = window.gameState.experience;
            xpBar.style.width = '100%'; // Siempre llena para mostrar XP disponible
            xpText.textContent = `${currentXP} XP`;
        }

        // Renderizar tabla compacta de upgrades
        function renderUpgradesGrid() {
            upgradesGrid.innerHTML = '';
            const stats = window.playerStats;
            const bonusActive = window.adBonusState && window.adBonusState.active;

            // Crear tabla
            const table = document.createElement('div');
            table.className = 'upgrades-table';
            table.style.cssText = `
                display: flex;
                flex-direction: column;
                gap: 4px;
                width: 100%;
                max-height: 60vh;
                overflow-y: auto;
                font-family: 'Rajdhani', sans-serif;
            `;

            for (let statName in stats) {
                const stat = stats[statName];
                const cost = stat.cost();
                const canAfford = window.gameState.experience >= cost;
                const currentValue = stat.currentValue;
                const bonusMultiplier = bonusActive ? 3 : 1;

                // Calcular siguiente valor
                // Siempre subimos 1 nivel, pero con bonus aplicamos el incremento 3 veces
                let nextValue;
                const nextLevel = stat.level + 1;

                if (statName === 'regeneration'){
                    // Regeneración aumenta en valores fijos
                    nextValue = currentValue + (stat.increment * bonusMultiplier);
                } else if (statName === 'criticalChance') {
                    // Valores fijos (no porcentuales)
                    nextValue = Math.min(currentValue + (stat.increment * bonusMultiplier), 1);

                } else {
                        nextValue = currentValue * Math.pow(1 + stat.increment, bonusMultiplier);

                }

                // Formatear valores según el tipo de stat
                let currentDisplay, nextDisplay;
                if (statName === 'fireRate') {
                    currentDisplay = Math.round(currentValue) + 'ms';
                    nextDisplay = Math.round(nextValue) + 'ms';
                } else if (statName === 'criticalChance') {
                    currentDisplay = (currentValue * 100).toFixed(0) + '%';
                    nextDisplay = (nextValue * 100).toFixed(0) + '%';
                } else if (statName === 'resilience') {
                    currentDisplay = ((1 - currentValue) * 100).toFixed(0) + '%';
                    nextDisplay = ((1 - nextValue) * 100).toFixed(0) + '%';
                } else if (statName === 'regeneration') {
                    currentDisplay = currentValue.toFixed(1);
                    nextDisplay = nextValue.toFixed(1);
                } else if (statName === 'pickupMagnet') {
                    currentDisplay = Math.round(currentValue);
                    nextDisplay = Math.round(nextValue);
                } else {
                    currentDisplay = currentValue.toFixed(1);
                    nextDisplay = nextValue.toFixed(1);
                }

                // Si hay bonus activo, resaltar el valor siguiente
                const nextValueColor = bonusActive ? '#FFD700' : '#00ff00';
                const nextValueGlow = bonusActive ? 'text-shadow: 0 0 10px #FFD700;' : '';

                const row = document.createElement('div');
                row.className = 'upgrade-row';
                row.style.cssText = `
                    display: grid;
                    grid-template-columns: 2fr 1fr 1fr 1fr 0.8fr;
                    gap: 8px;
                    align-items: center;
                    padding: 6px 10px;
                    background: ${canAfford ? 'rgba(0,255,255,0.05)' : 'rgba(255,255,255,0.02)'};
                    border: 1px solid ${canAfford ? 'rgba(0,255,255,0.3)' : 'rgba(255,255,255,0.1)'};
                    border-radius: 6px;
                    transition: all 0.3s ease;
                `;

                row.innerHTML = `
                    <div style="font-size: clamp(11px, 2vw, 13px); color: #00ffff; font-weight: 600; text-transform: uppercase;">${statNames[statName]}</div>
                    <div style="font-size: clamp(10px, 1.8vw, 12px); color: #fff; text-align: center;">${currentDisplay}</div>
                    <div style="font-size: clamp(10px, 1.8vw, 12px); color: ${canAfford ? '#ffff00' : '#666'}; text-align: center; font-weight: 600;">${cost} XP</div>
                    <div style="font-size: clamp(10px, 1.8vw, 12px); color: ${nextValueColor}; text-align: center; font-weight: ${bonusActive ? '700' : '400'}; ${nextValueGlow}">${nextDisplay}${bonusActive ? ' ⚡' : ''}</div>
                    <button class="upgrade-btn-compact" ${!canAfford ? 'disabled' : ''} data-stat="${statName}" style="
                        background: ${canAfford ? 'linear-gradient(135deg, #00ffff, #00cccc)' : 'rgba(100,100,100,0.3)'};
                        border: 1px solid ${canAfford ? '#00ffff' : '#666'};
                        color: ${canAfford ? '#000' : '#666'};
                        padding: 4px 8px;
                        border-radius: 4px;
                        font-size: clamp(10px, 1.8vw, 12px);
                        font-weight: 700;
                        cursor: ${canAfford ? 'pointer' : 'not-allowed'};
                        transition: all 0.2s ease;
                        font-family: 'Orbitron', sans-serif;
                    ">+</button>
                `;

                // Hover effect
                if (canAfford) {
                    row.onmouseenter = () => {
                        row.style.background = 'rgba(0,255,255,0.15)';
                        row.style.borderColor = 'rgba(0,255,255,0.6)';
                        row.style.boxShadow = '0 0 15px rgba(0,255,255,0.3)';
                    };
                    row.onmouseleave = () => {
                        row.style.background = 'rgba(0,255,255,0.05)';
                        row.style.borderColor = 'rgba(0,255,255,0.3)';
                        row.style.boxShadow = 'none';
                    };
                }

                // Event listener para el botón
                const btn = row.querySelector('.upgrade-btn-compact');
                btn.addEventListener('click', () => {
                    vibrateButton(50); // ✅ Vibración al mejorar stat
                    if (canAfford && typeof window.upgradePlayerStat === 'function') {
                        const success = window.upgradePlayerStat(statName);
                        if (success) {
                            // Animación de mejora
                            row.style.transform = 'scale(1.05)';
                            setTimeout(() => row.style.transform = 'scale(1)', 200);

                            // Animar barra de XP vaciándose
                            animateXPBar();

                            // Re-renderizar
                            renderUpgradesGrid();
                        }
                    }
                });

                table.appendChild(row);
            }

            upgradesGrid.appendChild(table);
        }

        // Exponer función globalmente
        window.renderUpgradesGrid = renderUpgradesGrid;

        // Animar barra de XP
        function animateXPBar() {
            const currentXP = window.gameState.experience;

            // Animación de vaciado
            xpBar.style.transition = 'width 0.3s ease';
            xpText.textContent = `${currentXP} XP`;

            // Reset para próxima animación
            setTimeout(() => {
                xpBar.style.transition = 'width 0.5s ease';
            }, 300);
        }

        // Botón de deshacer
        undoUpgradesBtn.addEventListener('click', () => {
            vibrateButton(50); // ✅ Vibración al deshacer
            if (typeof window.restoreStatsSnapshot === 'function') {
                window.restoreStatsSnapshot();
                updateXPBar();
                renderUpgradesGrid();
            }
        });

        // Botón de aceptar
        acceptUpgradesBtn.addEventListener('click', () => {
            vibrateButton(70); // ✅ Vibración más fuerte para confirmar upgrades
            upgradeModal.classList.remove('active');

            // Resetear el tracking de XP de la oleada
            if (typeof window.resetWaveExperience === 'function') {
                window.resetWaveExperience();
            }

            // Continuar con la siguiente oleada
            if (typeof window.gameState !== 'undefined') {
                window.gameState.isCountdown = false;
                window.gameState.isPaused = false;

                // Iniciar countdown de la siguiente oleada
                if (typeof window.startNextWaveCountdown === 'function') {
                    window.startNextWaveCountdown();
                }
            }
        });

        // Confirm modal function is available
        console.log('✅ showUpgradeModal function registered:', typeof window.showUpgradeModal);

        // Verificar que adBonusState esté disponible
        console.log('🎁 Checking adBonusState initialization...');
        if (typeof window.adBonusState !== 'undefined') {
            console.log('✅ adBonusState available:', JSON.stringify(window.adBonusState));
        } else {
            console.error('❌ adBonusState NOT available! This will cause issues.');
            // Crear un estado temporal por seguridad
            window.adBonusState = { active: false, canWatch: true };
            console.log('⚠️ Created temporary adBonusState as fallback');
        }

    </script>

    <!-- GAME OVER STATS SCRIPT -->
    <script>

        // Nombres bonitos para las stats
        const statNamesGameOver = {
            movementSpeed: 'Speed',
            fireRate: 'Fire Rate',
            resilience: 'Resilience',
            bulletDamage: 'Damage',
            maxHealth: 'Max HP',
            pickupMagnet: 'Magnet',
            criticalChance: 'Crit',
            regeneration: 'Regen'
        };

        // Actualizar stats en Game Over
        window.updateGameOverStats = function() {
            const gameOverStatsGrid = document.getElementById('gameOverStatsGrid');
            if (!gameOverStatsGrid || !window.playerStats) return;

            gameOverStatsGrid.innerHTML = '';

            for (let statName in window.playerStats) {
                const stat = window.playerStats[statName];
                const name = statNamesGameOver[statName] || statName;
                const currentValue = stat.currentValue;

                // Formatear valor según tipo de stat
                let displayValue;
                if (statName === 'fireRate') {
                    displayValue = Math.round(currentValue) + 'ms';
                } else if (statName === 'criticalChance') {
                    displayValue = (currentValue * 100).toFixed(0) + '%';
                } else if (statName === 'resilience') {
                    displayValue = ((1 - currentValue) * 100).toFixed(0) + '%';
                } else if (statName === 'regeneration') {
                    displayValue = currentValue.toFixed(1) + '/s';
                } else if (statName === 'pickupMagnet') {
                    displayValue = Math.round(currentValue);
                } else {
                    displayValue = currentValue.toFixed(1);
                }

                const statCard = document.createElement('div');
                statCard.style.cssText = `
                    background: rgba(0,255,255,0.1);
                    border: 1px solid rgba(0,255,255,0.3);
                    border-radius: 6px;
                    padding: 6px;
                    text-align: center;
                    transition: all 0.3s ease;
                `;

                statCard.innerHTML = `
                    <div style="font-size: clamp(9px, 1.6vw, 11px); color: #00ffff; text-transform: uppercase; margin-bottom: 2px;">${name}</div>
                    <div style="font-size: clamp(11px, 2vw, 14px); color: #fff; font-weight: 600;">Lv ${stat.level}</div>
                    <div style="font-size: clamp(10px, 1.8vw, 12px); color: #ffff00; font-weight: 500;">${displayValue}</div>
                `;

                // Efecto hover
                statCard.addEventListener('mouseenter', function() {
                    this.style.background = 'rgba(0,255,255,0.2)';
                    this.style.borderColor = 'rgba(0,255,255,0.6)';
                    this.style.boxShadow = '0 0 15px rgba(0,255,255,0.4)';
                });
                statCard.addEventListener('mouseleave', function() {
                    this.style.background = 'rgba(0,255,255,0.1)';
                    this.style.borderColor = 'rgba(0,255,255,0.3)';
                    this.style.boxShadow = 'none';
                });

                gameOverStatsGrid.appendChild(statCard);
            }
        };

        console.log('✅ updateGameOverStats function registered');
    </script>

    <!-- GAME OVER BUTTON EFFECTS SCRIPT -->
    <script>
        // Añadir efectos hover a los botones de Game Over cuando se cargue la página
        document.addEventListener('DOMContentLoaded', function() {
            const continueBtn = document.getElementById('continueWithAdBtn');
            if (continueBtn) {
                continueBtn.addEventListener('mouseenter', function() {
                    this.style.transform = 'scale(1.05)';
                    this.style.boxShadow = '0 0 30px rgba(255,215,0,0.8)';
                });
                continueBtn.addEventListener('mouseleave', function() {
                    this.style.transform = 'scale(1)';
                    this.style.boxShadow = '0 0 20px rgba(255,215,0,0.5)';
                });
            }

            // Efecto hover para botón Play Again
            const playAgainBtns = document.querySelectorAll('.btn-game-over-primary');
            playAgainBtns.forEach(btn => {
                btn.addEventListener('mouseenter', function() {
                    this.style.transform = 'scale(1.05)';
                    this.style.boxShadow = '0 0 30px rgba(0,255,255,0.8)';
                });
                btn.addEventListener('mouseleave', function() {
                    this.style.transform = 'scale(1)';
                    this.style.boxShadow = '0 0 20px rgba(0,255,255,0.5)';
                });
            });
        });
    </script>

    <!-- DEBUG PAUSE BUTTON SCRIPT -->
    <script>
        const debugPauseBtn = document.getElementById('debugPauseBtn');
        let debugPaused = false;

        debugPauseBtn.addEventListener('click', () => {
            vibrateButton(50); // ✅ Vibración al pausar debug
            debugPaused = !debugPaused;

            if (debugPaused) {
                // Pausar el juego SIN mostrar overlays
                if (window.gameState) {
                    window.gameState.isPaused = true;
                    window.gameState.isPlaying = false;
                }

                debugPauseBtn.textContent = '▶';
                debugPauseBtn.style.background = 'green';

                console.log('🔍 ==================== DEBUG PAUSE ====================');
                console.log('🎮 Game paused for debugging');

                // Listar TODOS los elementos con sus propiedades
                const elements = [
                    { id: 'gameCanvas', name: 'CANVAS PRINCIPAL', cssFile: 'css/global.css', cssSelector: '#gameCanvas', htmlLine: '~3843' },
                    { id: 'startMenu', name: 'MENÚ INICIO', cssFile: 'N/A (inline)', cssSelector: '.start-menu', htmlLine: '~3286' },
                    { id: 'gameHUD', name: 'HUD', cssFile: 'css/game-ui.css', cssSelector: '.hud', htmlLine: '~3673' },
                    { id: 'mobileControls', name: 'CONTROLES MÓVILES', cssFile: 'css/mobile-controls.css', cssSelector: '.mobile-controls', htmlLine: '~3701' },
                    { id: 'joystickContainer', name: 'JOYSTICK MOVIMIENTO', cssFile: 'css/mobile-controls.css', cssSelector: '.joystick-container', htmlLine: '~3707' },
                    { id: 'shootJoystickContainer', name: 'JOYSTICK DISPARO', cssFile: 'css/mobile-controls.css', cssSelector: '.shoot-joystick-container', htmlLine: '~3712' },
                    { id: 'pauseOverlay', name: 'OVERLAY PAUSA', cssFile: 'index.html (inline)', cssSelector: '#pauseOverlay', htmlLine: '~3791' },
                    { id: 'gameOver', name: 'GAME OVER', cssFile: 'index.html (inline)', cssSelector: '#gameOver, .game-over', htmlLine: '~3815' },
                    { id: 'upgradeModal', name: 'MODAL UPGRADES', cssFile: 'index.html (inline)', cssSelector: '.upgrade-modal', htmlLine: '~3752' },
                    { id: 'loadingScreen', name: 'PANTALLA CARGA', cssFile: 'css/game-ui.css', cssSelector: '.loading-screen', htmlLine: '~3663' },
                    { id: 'levelSelector', name: 'SELECTOR NIVELES', cssFile: 'index.html (inline)', cssSelector: '.level-selector', htmlLine: '~3551' },
                    { id: 'statsPage', name: 'PÁGINA ESTADÍSTICAS', cssFile: 'index.html (inline)', cssSelector: '.stats-page', htmlLine: '~3564' },
                    { id: 'userOptionsModal', name: 'MODAL OPCIONES USUARIO', cssFile: 'index.html (inline)', cssSelector: '.modal-overlay', htmlLine: '~3424' },
                    { id: 'avatarSelectionModal', name: 'MODAL SELECCIÓN AVATAR', cssFile: 'index.html (inline)', cssSelector: '.avatar-modal-overlay', htmlLine: '~3450' },
                    { id: 'waveCountdown', name: 'COUNTDOWN OLEADA', cssFile: 'index.html (inline)', cssSelector: '.wave-countdown', htmlLine: '~3747' },
                    { id: 'waveIndicator', name: 'INDICADOR OLEADA', cssFile: 'index.html (inline)', cssSelector: '.wave-indicator', htmlLine: '~3744' },
                    { id: 'notification', name: 'NOTIFICACIÓN', cssFile: 'index.html (inline)', cssSelector: '.notification', htmlLine: '~3741' },
                    { id: 'customCursor', name: 'CURSOR PERSONALIZADO', cssFile: 'css/global.css', cssSelector: '.custom-cursor', htmlLine: '~3838' },
                    { id: 'debugPauseBtn', name: 'BOTÓN DEBUG (ESTE)', cssFile: 'index.html (inline)', cssSelector: '#debugPauseBtn', htmlLine: '~3698' }
                ];

                console.log('📋 LISTA DE ELEMENTOS HTML (con ubicación en código):');
                console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');

                elements.forEach(item => {
                    const el = document.getElementById(item.id);
                    if (el) {
                        const styles = window.getComputedStyle(el);
                        console.log(`\n🔹 ${item.name}`);
                        console.log(`   📄 ID HTML: "${item.id}"`);
                        console.log(`   📍 Ubicación HTML: Línea ${item.htmlLine} en index.html`);
                        console.log(`   🎨 CSS Selector: "${item.cssSelector}"`);
                        console.log(`   📂 Archivo CSS: ${item.cssFile}`);
                        console.log(`   🏷️  Tag: <${el.tagName.toLowerCase()}>`);
                        console.log(`   ├─ display: ${styles.display}`);
                        console.log(`   ├─ visibility: ${styles.visibility}`);
                        console.log(`   ├─ opacity: ${styles.opacity}`);
                        console.log(`   ├─ position: ${styles.position}`);
                        console.log(`   ├─ zIndex: ${styles.zIndex}`);
                        console.log(`   ├─ top: ${styles.top}`);
                        console.log(`   ├─ left: ${styles.left}`);
                        console.log(`   ├─ width: ${styles.width}`);
                        console.log(`   ├─ height: ${styles.height}`);
                        console.log(`   ├─ transform: ${styles.transform}`);
                        console.log(`   └─ pointer-events: ${styles.pointerEvents}`);

                        // Información de clase
                        if (el.className) {
                            console.log(`   📦 classes: "${el.className}"`);
                        }

                        // Calcular si está en viewport
                        const rect = el.getBoundingClientRect();
                        const inViewport = rect.top < window.innerHeight && rect.bottom > 0 && rect.left < window.innerWidth && rect.right > 0;
                        console.log(`   👁️  En viewport: ${inViewport ? '✅ SÍ' : '❌ NO'}`);
                        console.log(`   📐 Rect: {top:${rect.top.toFixed(0)}, left:${rect.left.toFixed(0)}, width:${rect.width.toFixed(0)}, height:${rect.height.toFixed(0)}}`);
                    } else {
                        console.log(`\n❌ ${item.name} (ID: "${item.id}") - NO ENCONTRADO`);
                    }
                });

                // Información del body
                console.log('\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
                console.log('🔹 BODY');
                console.log('   📄 Tag: <body>');
                console.log('   📍 CSS: css/global.css → html, body { ... }');
                const bodyStyles = window.getComputedStyle(document.body);
                console.log(`   ├─ display: ${bodyStyles.display}`);
                console.log(`   ├─ position: ${bodyStyles.position}`);
                console.log(`   ├─ background: ${bodyStyles.background}`);
                console.log(`   ├─ overflow: ${bodyStyles.overflow}`);
                console.log(`   ├─ width: ${bodyStyles.width}`);
                console.log(`   └─ height: ${bodyStyles.height}`);

                // Información de viewport
                console.log('\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
                console.log('📱 VIEWPORT INFO:');
                console.log(`   ├─ window.innerWidth: ${window.innerWidth}`);
                console.log(`   ├─ window.innerHeight: ${window.innerHeight}`);
                console.log(`   ├─ screen.width: ${screen.width}`);
                console.log(`   ├─ screen.height: ${screen.height}`);
                console.log(`   └─ devicePixelRatio: ${window.devicePixelRatio}`);

                // Estado del juego
                console.log('\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
                console.log('🎮 GAME STATE (variables en game.js):');
                if (window.gameState) {
                    console.log(`   ├─ isPlaying: ${window.gameState.isPlaying}`);
                    console.log(`   ├─ isPaused: ${window.gameState.isPaused}`);
                    console.log(`   ├─ isGameOver: ${window.gameState.isGameOver}`);
                    console.log(`   └─ wave: ${window.gameState.wave}`);
                }

                // ENEMIGOS - Información detallada
                console.log('\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
                console.log('👾 ENEMIGOS (array window.enemies en game.js):');
                console.log('   📄 Definición: game.js → let enemies = [];');
                console.log('   📍 Renderizado: game.js → función render() línea ~1850-2100');
                console.log('   🎨 NO tienen elemento HTML (se dibujan en canvas)');
                console.log('   🖌️  Se renderizan con: ctx.arc() y ctx.fill()');

                if (window.enemies && window.enemies.length > 0) {
                    console.log(`   📊 Total enemigos activos: ${window.enemies.length}`);
                    console.log('');
                    window.enemies.forEach((enemy, index) => {
                        console.log(`   👾 ENEMY #${index + 1}:`);
                        console.log(`      ├─ type: ${enemy.type || 'BASIC'}`);
                        console.log(`      ├─ position: (x:${enemy.x.toFixed(1)}, y:${enemy.y.toFixed(1)})`);
                        console.log(`      ├─ radius: ${enemy.radius.toFixed(1)}`);
                        console.log(`      ├─ color: ${enemy.color || '#ff00ff'}`);
                        console.log(`      ├─ health: ${enemy.health.toFixed(1)}/${enemy.maxHealth.toFixed(1)}`);
                        console.log(`      ├─ speed: ${enemy.speed.toFixed(2)}`);
                        console.log(`      └─ 🔍 Buscar en game.js: "enemies.push({ type: '${enemy.type}'")`);
                    });
                } else {
                    console.log('   ⚠️  No hay enemigos activos en este momento');
                }

                // JUGADOR - Información detallada
                console.log('\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
                console.log('🎮 JUGADOR (objeto window.player en game.js):');
                console.log('   📄 Definición: game.js → let player = { x, y, radius, ... };');
                console.log('   📍 Renderizado: game.js → función render() línea ~2150-2180');
                console.log('   🎨 NO tiene elemento HTML (se dibuja en canvas)');
                console.log('   🖌️  Se renderiza con: ctx.arc() y ctx.fill()');

                if (window.player) {
                    console.log('');
                    console.log(`   🎮 PLAYER:`);
                    console.log(`      ├─ position: (x:${window.player.x.toFixed(1)}, y:${window.player.y.toFixed(1)})`);
                    console.log(`      ├─ targetPos: (x:${window.player.targetX?.toFixed(1)}, y:${window.player.targetY?.toFixed(1)})`);
                    console.log(`      ├─ radius: ${window.player.radius}`);
                    console.log(`      ├─ color: ${window.player.color || '#00ffff'}`);
                    console.log(`      ├─ health: ${window.player.health?.toFixed(1)}/${window.player.maxHealth}`);
                    console.log(`      ├─ speed: ${window.player.speed}`);
                    console.log(`      └─ 🔍 Buscar en game.js: "let player = {"`);
                } else {
                    console.log('   ⚠️  Player object no encontrado');
                }

                // BALAS - Información
                console.log('\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
                console.log('💥 BALAS (array window.bullets en game.js):');
                console.log('   📄 Definición: game.js → let bullets = [];');
                console.log('   📍 Renderizado: game.js → función render() línea ~2030-2050');
                console.log('   🎨 NO tienen elemento HTML (se dibujan en canvas)');
                if (window.bullets) {
                    console.log(`   📊 Total balas activas: ${window.bullets.length}`);
                }

                // Canvas específico con análisis de píxeles
                const canvas = document.getElementById('gameCanvas');
                if (canvas) {
                    console.log('\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
                    console.log('🎨 CANVAS DETALLE:');
                    console.log('   📄 ID HTML: "gameCanvas"');
                    console.log('   📍 Ubicación HTML: Línea ~3843 en index.html');
                    console.log('   🎨 CSS Selector: "#gameCanvas"');
                    console.log('   📂 Archivo CSS: css/global.css');
                    console.log(`   ├─ canvas.width: ${canvas.width}`);
                    console.log(`   ├─ canvas.height: ${canvas.height}`);
                    console.log(`   ├─ canvas.style.width: ${canvas.style.width}`);
                    console.log(`   └─ canvas.style.height: ${canvas.style.height}`);

                    // Intentar obtener píxeles del canvas en diferentes posiciones
                    try {
                        const ctx = canvas.getContext('2d');
                        if (ctx) {
                            // Centro
                            const centerData = ctx.getImageData(canvas.width/2, canvas.height/2, 1, 1);
                            const centerPixel = centerData.data;
                            console.log(`   🔍 Pixel CENTRO (${canvas.width/2}, ${canvas.height/2}):`);
                            console.log(`      ├─ RGBA: (${centerPixel[0]}, ${centerPixel[1]}, ${centerPixel[2]}, ${centerPixel[3]})`);
                            console.log(`      └─ Tiene contenido: ${centerPixel[3] > 0 ? '✅ SÍ' : '❌ NO (transparente)'}`);

                            // Esquina superior izquierda
                            const topLeftData = ctx.getImageData(10, 10, 1, 1);
                            const topLeftPixel = topLeftData.data;
                            console.log(`   🔍 Pixel ESQUINA (10, 10):`);
                            console.log(`      ├─ RGBA: (${topLeftPixel[0]}, ${topLeftPixel[1]}, ${topLeftPixel[2]}, ${topLeftPixel[3]})`);
                            console.log(`      └─ Tiene contenido: ${topLeftPixel[3] > 0 ? '✅ SÍ' : '❌ NO (transparente)'}`);

                            // Posición del jugador si existe
                            if (window.player) {
                                const playerData = ctx.getImageData(Math.floor(window.player.x), Math.floor(window.player.y), 1, 1);
                                const playerPixel = playerData.data;
                                console.log(`   🔍 Pixel JUGADOR (${Math.floor(window.player.x)}, ${Math.floor(window.player.y)}):`);
                                console.log(`      ├─ RGBA: (${playerPixel[0]}, ${playerPixel[1]}, ${playerPixel[2]}, ${playerPixel[3]})`);
                                console.log(`      └─ Tiene contenido: ${playerPixel[3] > 0 ? '✅ SÍ (jugador dibujado)' : '❌ NO (no hay píxel)'}`);
                            }
                        }
                    } catch(e) {
                        console.log(`   ❌ Error leyendo píxeles: ${e.message}`);
                    }
                }

                console.log('\n🔍 ====================================================');
                console.log('💡 CÓMO BUSCAR EN EL CÓDIGO:');
                console.log('   🔎 En HTML: Busca por ID (ej: id="gameCanvas")');
                console.log('   🔎 En CSS: Busca por selector (ej: #gameCanvas o .hud)');
                console.log('   🔎 En game.js: Busca por variable (ej: let player, let enemies)');
                console.log('   🔎 Enemigos/Jugador: NO están en HTML, se dibujan en canvas');
                console.log('💡 Presiona ▶ (botón verde) para reanudar el juego');
                console.log('🔍 ====================================================\n');

            } else {
                // Reanudar juego
                if (window.gameState) {
                    window.gameState.isPaused = false;
                    window.gameState.isPlaying = true;
                }

                debugPauseBtn.textContent = '⏸';
                debugPauseBtn.style.background = 'red';

                console.log('▶️ Game resumed');
            }
        });

        console.log('🐛 Debug pause button initialized - Click red button to pause and inspect');
    </script>    <!-- Modular JavaScript - Load Order Matters! -->
    <script src="js/config.js"></script>
    <script src="js/ui-manager.js"></script>
    <script src="js/firebase-handler.js"></script>
    <script src="js/pseudo-3d-renderer.js"></script>
    <script src="js/map-system.js"></script>
    <script src="js/dynamic-joystick.js"></script>
    <script src="js/ammo-system.js"></script>
    <script src="js/super-system.js"></script>
    <script src="game.js"></script>

    <script>
        // Initialize Firebase after config is loaded
        if (typeof firebaseHandler !== 'undefined') {
            firebaseHandler.init();

            // Set global references for legacy code compatibility
            auth = firebaseHandler.auth;
            db = firebaseHandler.db;

            console.log('✅ Firebase initialized, auth and db available');
        } else {
            console.error('❌ firebaseHandler not found!');
        }

        console.log('✅ All modules loaded successfully');
    </script>
</body>
</html>